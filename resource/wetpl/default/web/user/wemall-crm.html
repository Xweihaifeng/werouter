<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>商城CRM</title>
    <script src="/common/js/jquery-3.2.1.min.js"></script>
    <script src="{{PATH_CONFIG}}"></script>
    <link rel="stylesheet" href="{{PATH_TML}}user/css/wemall-crm.css">
    <link rel="stylesheet" type="text/css" href="/common/iview/iview.css">
    <script src="/common/public/js/app.js"></script>
    <script src="/common/iview/vue.min.js"></script>
    <!-- 引入组件库 -->
    <script src="/common/iview/iview.min.js"></script>
    <script src="/common/iview/axios.min.js"></script>
    <script src="/common/iview/libs/util.js"></script>
    <script src="/common/iview/libs/filter.js"></script>
    <script src="/common/js/echart/echarts.js"></script>
    <script src="/common/js/plupload/plupload.full.min.js"></script>
    <script src="/common/js/qiniu.js"></script>
    <script src="/common/js/ckeditor/ckeditor.js"></script>
    <style>
        .demo-upload-list{
            display: inline-block;
            width: 60px;
            height: 60px;
            text-align: center;
            line-height: 60px;
            border: 1px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            background: #fff;
            position: relative;
            box-shadow: 0 1px 1px rgba(0,0,0,.2);
            margin-right: 4px;
        }
        .demo-upload-list img{
            width: 100%;
            height: 100%;
        }
        .demo-upload-list-cover{
            display: none;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,.6);
        }
        .demo-upload-list:hover .demo-upload-list-cover{
            display: block;
        }
        .demo-upload-list-cover i{
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            margin: 0 2px;
        }
    </style>

    <script>
        var qiniu_upload_url='http://up-z1.qiniu.com';
        var qiniu_uptoken = '';
        var saveto ='qiniu';
        var qiniu_bucket_domain = ApiMaterPlatQiniuDomain;
        var __init = function(){
            $.ajax({
                url:  QINIU_UPTOKEN_URL,
                type: 'get',
                dataType: 'json',
                success: function(data){
                    qiniu_uptoken = data.uptoken;
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        }
        __init();

    </script>
    <style>
        .ivu-coupon-content{
            border: 1px solid #e9eaec;
        }
        .ivu-coupon-content img{
            max-width: 730px;
            height: auto;
        }
        .name{
            box-sizing: border-box;
            padding-right: 26px;
        }
        .name > span{
            float: right;
        }
        .ling{
            float: left;
        }
        .rows{
            height: auto;
            min-height: 30px;
            line-height: 30px;
            overflow: hidden;
        }
        /*.line-right{*/
            /*border-right: 1px solid #e9eaec;*/
        /*}*/
        /*.rows > i-col{*/
            /*height: 30px;*/
            /*line-height: 30px;*/
        /*}*/
    </style>
</head>
<body style="width: 100%; background: #F7F6F2;">

<div id="app">
    <div class="crm-header">
        <ul>
            <li class="logo">微众中国</li>
            <li><a :href="'/'+domain">首页</a></li>
            <li class="back"><a href="/user/admin/wemall/goods/list">返回</a></li>
        </ul>
    </div>
    <div class="wemall-crm" v-cloak>
        <ul class="menu">
            <li v-for="(item,key) in menuList" :class="{'active' : currentState == key}" @click="currentState=key">
                {{item}}
            </li>
        </ul>
        <div class="crm-content">
            <div class="chart-list" v-show="currentState == 0">
                <template v-if="StatisticsFlag">
                    <div class="chart-dom" v-for="item in 3" :id="'show-chart'+item" :option="'option'+item"></div>
                </template>
                <template v-else>
                    <div class="form-list" style="text-align: center;">商城还没有统计数据</div>
                </template>
            </div>
            <div v-show="currentState == 1">
                <div class="form-list">
                    <i-form ref="formItemMember" :model="formItemMember" :rules="formItemMemberValidate" :label-width="100">
                        <form-item label="会员卡名称" prop="levels_name">
                            <i-input v-model="formItemMember.levels_name" placeholder="请输入会员卡名称"></i-input>
                        </form-item>
                        <form-item label="会员卡类型" prop="conditions">
                            <i-select v-model="formItemMember.conditions">
                                <i-option value='1'>进店自动获取</i-option>
                                <i-option value='2'>单笔消费满额</i-option>
                                <i-option value='3'>累计消费满额</i-option>
                            </i-select>
                        </form-item>
                        <form-item label="会员卡折扣" prop="discount">
                            <i-input v-model="formItemMember.discount" placeholder="请输入会员卡折扣1-10折"></i-input>
                        </form-item>
                        <form-item label="限制条件" prop="money" v-show="formItemMember.conditions == 2 || formItemMember.conditions == 3">
                            <i-input v-model="formItemMember.money" placeholder="请输入升级金额"></i-input>
                        </form-item>
                        <form-item label="会员卡样式" prop="card_style">
                            <i-select v-model="formItemMember.card_style"  @on-change="selectCardStyle">
                                <i-option value='1'>1</i-option>
                                <i-option value='2'>2</i-option>
                                <i-option value='3'>3</i-option>
                                <i-option value='4'>4</i-option>
                                <i-option value='5'>5</i-option>
                                <i-option value='6'>6</i-option>
                                <i-option value='7'>7</i-option>
                                <i-option value='8'>8</i-option>
                                <i-option value='9'>9</i-option>
                                <i-option value='10'>10</i-option>
                                <i-option value='11'>11</i-option>
                                <i-option value='12'>12</i-option>
                                <i-option value='13'>13</i-option>
                                <i-option value='14'>14</i-option>
                                <i-option value='15'>15</i-option>
                                <i-option value='16'>16</i-option>
                                <i-option value='17'>17</i-option>
                                <i-option value='18'>18</i-option>
                                <i-option value='19'>19</i-option>
                                <i-option value='20'>20</i-option>
                                <i-option value='21'>21</i-option>
                                <i-option value='22'>22</i-option>
                                <i-option value='23'>23</i-option>
                            </i-select>
                        </form-item>
                        <form-item label="样式图">
                            <img :src="formItemMemberCardImge">
                        </form-item>
                        <form-item label="字体颜色景色" prop="card_font_colour">
                            <color-picker v-model="formItemMember.card_font_colour" recommend />
                        </form-item>

                        <form-item>
                            <i-button type="primary" @click="handleLevelsmit('formItemMember')">保存</i-button>
                            <i-button type="ghost" style="margin-left: 8px">取消</i-button>
                        </form-item>
                    </i-form>
                </div>
            </div>
            <div v-show="currentState == 2">
                <div class="form-list">
                    <template v-if="Memberflag">
                        <i-button type="primary" style="float:left;margin-left:40px;"  @click="MallMemberListCardClick()">会员卡列表</i-button>
                        <i-button style="float:left;margin-left:40px;" @click="MallMemberListClick()" >会员列表</i-button>
                    </template>
                    <template v-else>
                        <i-button style="float:left;margin-left:40px;"  @click="MallMemberListCardClick()">会员卡列表</i-button>
                        <i-button type="primary" style="float:left;margin-left:40px;" @click="MallMemberListClick()" >会员列表</i-button>
                    </template>
                    <div class="table-list" v-show="Memberflag">
                        <i-table size="default" border stripe :columns="columnsMemberLevel" :data="MemberLeveldata"></i-table>
                    </div>
                    <div class="table-list" v-show="this.MallMemberList.MallMemberListflag">
                        <i-table size="default" border stripe :columns="MallMemberList.columnsMallMemberList" :data="MallMemberList.MallMemberListData"></i-table>
                        <div style="margin: 10px;overflow: hidden">
                            <Page :total="MallMemberList.MallMemberListTotal" @on-change="MallMemberListPage" :page-size="MallMemberList.MallMemberListPageSize"></Page>
                        </div>
                    </div>
                </div>
            </div>
            <div v-show="currentState == 3">
                <div class="form-list">
                    <i-form ref="formItemMemberCoupon" style="width: 100%;" :model="formItemMemberCoupon" :rules="formItemMemberCouponValidate" :label-width="150">
                        <form-item label="优惠卷名称" prop="name">
                            <i-input v-model="formItemMemberCoupon.name" placeholder="请输入优惠卷名称"></i-input>
                        </form-item>
                        <form-item label="优惠卷描述">
                            <i-input v-model="formItemMemberCoupon.description" type="textarea" :autosize="{minRows: 2,maxRows: 5}" placeholder="请输入优惠卷描述"></i-input>
                        </form-item>
                        <form-item label="背景色" prop="colour">
                            <color-picker v-model="formItemMemberCoupon.colour" recommend />
                        </form-item>
                        <form-item label="领取限制" prop="get_condition">
                            <i-select v-model="formItemMemberCoupon.get_condition">
                                <i-option value='1'>用户注册</i-option>
                                <i-option value='2'>满足等级</i-option>
                                <i-option value='3'>无限制</i-option>
                            </i-select>
                        </form-item>
                        <form-item label="每次领取张数" prop="get_restrict">
                            <i-input v-model="formItemMemberCoupon.get_restrict" placeholder="请输入每次领取的张数"></i-input>
                        </form-item>
                        <form-item label="会员等级" prop="levels" v-show="formItemMemberCoupon.get_condition == 2" >
                            <i-select v-model="formItemMemberCoupon.levels">
                                <i-option v-for="(item,index) in formItemMemberCouponlevels"  :value="item.levels">{{ item.levels }}</i-option>
                            </i-select>
                        </form-item>
                        <form-item label="优惠卷类型" prop="coupon_type">
                            <i-select v-model="formItemMemberCoupon.coupon_type">
                                <i-option value='1'>现金优惠券</i-option>
                                <i-option value='2'>折扣优惠券</i-option>
                                <i-option value='3'>抵用优惠券</i-option>
                            </i-select>
                        </form-item>
                        <form-item label="每张优惠金额" prop="amount">
                            <i-input v-model="formItemMemberCoupon.amount" placeholder="请输入每张优惠卷的优惠金额"></i-input>
                        </form-item>
                        <form-item label="其他优惠一起使用" prop="is_reuse">
                            <radio-group v-model="formItemMemberCoupon.is_reuse">
                                <radio label="1">是</radio>
                                <radio label="2">否</radio>
                            </radio-group>
                        </form-item>
                        <form-item label="使用限制" prop="use_restrictions">
                            <i-input v-model="formItemMemberCoupon.use_restrictions" placeholder="请输入使用限制（满多少元可用）"></i-input>
                        </form-item>
                        <form-item label="领取时间" prop="receive_time" class="ivu-form-item-required">
                            <date-picker v-model="formItemMemberCoupon.receive_time" format="yyyy/MM/dd" type="daterange" :options="receive_time_options" placement="bottom-end" placeholder="请输入领取时间段" style="width: 200px"></date-picker>
                        </form-item>
                        <form-item label="使用期限"  prop="activity_time">
                            <i-input v-model="formItemMemberCoupon.activity_time" placeholder="请输入使用期限（安天算）"></i-input>
                        </form-item>
                        <!--上传成功显示图片隐藏上传域-->
                        <form-item label="推广图片" class="ivu-form-item-required" >
                            <template>
                            <div class="demo-upload-list" v-for="item in uploadList">
                                <template v-if="item.status === 'finished'">
                                    <img :src="item.url">
                                    <div class="demo-upload-list-cover">
                                        <icon type="ios-trash-outline" @click.native="handleRemove(item)"></icon>
                                    </div>
                                </template>
                                <template v-else>
                                    <i-progress v-if="item.showProgress" :percent="item.percentage" hide-info></i-progress>
                                </template>
                            </div>
                            <upload
                                    ref="upload"
                                    :show-upload-list="false"
                                    :on-success="handleSuccess"
                                    :format="['jpg','jpeg','png']"
                                    :max-size="2048"
                                    :on-format-error="handleFormatError"
                                    :on-exceeded-size="handleMaxSize"
                                    :before-upload="handleBeforeUpload"
                                    :data="uploadData"
                                    multiple
                                    type="drag"
                                    :action="uploadUrl"
                                    style="display: inline-block;width:58px;">
                                <div style="width: 58px;height:58px;line-height: 58px;">
                                    <icon type="camera" size="20"></icon>
                                </div>
                            </upload>
                            </template>
                        </form-item>
                        <form-item label="推广标题" prop="title">
                            <i-input v-model="formItemMemberCoupon.title" placeholder="请输入推广标题"></i-input>
                        </form-item>
                        <form-item label="推广内容" prop="content">
                            <textarea  id="Couponcontent" >{{formItemMemberCoupon.content}}</textarea>
                            <!--<i-input v-model="formItemMemberCoupon.content" type="textarea"  :autosize="{minRows: 2,maxRows: 5}"  placeholder="请输入推广内容"></i-input>-->
                        </form-item>
                        <form-item>
                            <i-button type="primary" @click="handleCouponmit('formItemMemberCoupon')">保存</i-button>
                            <i-button type="ghost" style="margin-left: 8px">取消</i-button>
                        </form-item>
                    </i-form>
                </div>
            </div>
            <div v-show="currentState == 4">
                <div class="form-list">
                    <template v-if="Couponflag">
                        <i-button type="primary" style="float:left;margin-left:40px;" @click="CouponListClick()" >优惠卷列表</i-button>
                        <i-button style="float:left;margin-left:40px;" @click="CouponRecordListClick()" >优惠卷领取记录</i-button>
                    </template>
                    <template v-else>
                        <i-button style="float:left;margin-left:40px;" @click="CouponListClick()" >优惠卷列表</i-button>
                        <i-button type="primary" style="float:left;margin-left:40px;" @click="CouponRecordListClick()" >优惠卷领取记录</i-button>
                    </template>
                    <div class="table-list" v-show="Couponflag">
                        <i-table size="default" border stripe  :columns="columnsMemberCoupon" :data="MemberCoupondata"></i-table>
                        <div style="margin: 10px;overflow: hidden">
                            <Page :total="columnsMemberCouponTotal" :current="Couponcurrent" @on-change="CouponPage" :page-size="Couponpagesize"></Page>
                        </div>
                    </div>
                    <div class="table-list" v-show="CouponRecordList.CouponRecordflag">
                        <i-table size="default" border stripe :columns="CouponRecordList.columnsCouponRecordList" :data="CouponRecordList.CouponRecordListData"></i-table>
                        <div style="margin: 10px;overflow: hidden">
                            <Page :total="CouponRecordList.CouponRecordListTotal" @on-change="CouponRecordListPage" :page-size="CouponRecordList.CouponRecordListPageSize"></Page>
                        </div>
                    </div>
                </div>
                <modal v-model="modalCouponDetail" title="优惠卷详情" width="800">
                    <card>
                        <Row class="rows" style="margin-bottom: 10px;border-bottom: 1px solid #e9eaec" >
                            <i-col span="6" class="name"><span>优惠卷名称:</span></i-col>
                            <i-col span="6" class="line-right">{{modalCouponDetailData.name}}</i-col>
                            <i-col span="6" class="name" class="ling"><span>优惠卷描述:</span></i-col>
                            <i-col span="6">{{modalCouponDetailData.description}}</i-col>
                        </Row>
                        <!--<Row style="margin-bottom: 10px;">-->

                        <!--</Row>-->
                        <Row class="rows" style="margin-bottom: 10px;border-bottom: 1px solid #e9eaec">
                            <i-col span="6" class="name"><span>背景色:</span></i-col>
                            <i-col span="6" class="line-right"> <div :style="'background-color:'+modalCouponDetailData.colour+'; width: 15px; height: 15px; margin-top: 8px;'"></div></i-col>
                            <i-col span="6" class="name"><span>领取限制:</span></i-col>
                            <i-col span="6">{{modalCouponDetailData.get_condition}}</i-col>
                        </Row>
                        <!--<Row style="margin-bottom: 10px;">-->
                            <!---->
                        <!--</Row>-->
                        <Row class="rows" style="margin-bottom: 10px;border-bottom: 1px solid #e9eaec">
                            <i-col span="6" class="name"><span>每次领取张数:</span></i-col>
                            <i-col span="6" class="line-right">{{modalCouponDetailData.get_restrict}}</i-col>
                            <i-col span="6" class="name"><span>会员等级:</span></i-col>
                            <i-col span="6">{{modalCouponDetailData.levels}}</i-col>
                        </Row>
                        <!--<Row style="margin-bottom: 10px;">-->
                            <!---->
                        <!--</Row>-->
                        <Row class="rows" style="margin-bottom: 10px;border-bottom: 1px solid #e9eaec">
                            <i-col span="6" class="name"><span>优惠卷类型:</span></i-col>
                            <i-col span="6" class="line-right">{{modalCouponDetailData.coupon_type}}</i-col>
                            <i-col span="6" class="name"><span>每张优惠金额:</span></i-col>
                            <i-col span="6">{{modalCouponDetailData.amount}}</i-col>
                        </Row>
                        <!--<Row style="margin-bottom: 10px;">-->
                            <!---->
                        <!--</Row>-->
                        <Row class="rows" style="margin-bottom: 10px;border-bottom: 1px solid #e9eaec">
                            <i-col span="6" class="name"><span>其他优惠一起使用:</span></i-col>
                            <i-col span="6" class="line-right">{{modalCouponDetailData.is_reuse}}</i-col>
                            <i-col span="6" class="name"><span>使用限制:</span></i-col>
                            <i-col span="6">{{modalCouponDetailData.use_restrictions}}</i-col>
                        </Row>
                        <!--<Row style="margin-bottom: 10px;">-->
                            <!---->
                        <!--</Row>-->
                        <Row class="rows" style="margin-bottom: 10px;border-bottom: 1px solid #e9eaec">
                            <i-col span="6" class="name"><span>领取时间:</span></i-col>
                            <i-col span="6" class="line-right">{{modalCouponDetailData.receive_time}}</i-col>
                            <i-col span="6" class="name"><span>使用期限:</span></i-col>
                            <i-col span="6">{{modalCouponDetailData.activity_time}}</i-col>
                        </Row>
                        <!--<Row style="margin-bottom: 10px;">-->
                            <!---->
                        <!--</Row>-->
                        <Row class="rows" style="margin-bottom: 10px;border-bottom: 1px solid #e9eaec">
                            <i-col span="6" class="name"><span>推广标题:</span></i-col>
                            <i-col span="6">{{modalCouponDetailData.title}}</i-col>

                        </Row>
                        <Row  class="rows" style="margin-bottom: 10px;">
                            <i-col span="6" class="name"><span>推广图片:</span></i-col>
                            <i-col span="6"><img :src="modalCouponDetailData.picture" alt="" style="display: block; width: 200px; height: 100px;"></i-col>
                        </Row>
                        <Row>
                            <i-col span="6" class="name"><span style="">推广内容:</span></i-col>
                        </Row>
                        <Row>
                            <i-col class="ivu-coupon-content" v-html='modalCouponDetailData.content'></i-col>
                        </Row>

                    </card>
                </modal>
                <modal v-model="CouponRecordList.modalCouponUserRecordDetail" title="优惠卷领取详情" width="800">
                    <card>
                        <Row style="margin-bottom: 10px;">
                            <i-col span="4">序号:</i-col>
                            <i-col span="4">优惠卷名称:</i-col>
                            <i-col span="4">优惠卷类型:</i-col>
                            <i-col span="4">过期时间:</i-col>
                            <i-col span="4">是否过期:</i-col>
                            <i-col span="4">状态:</i-col>
                        </Row>
                        <Row style="margin-bottom: 10px;" v-for="(item,key) in CouponRecordList.modalCouponUserRecordDetailData">
                            <i-col span="4">{{item.id}}</i-col>
                            <i-col span="4">{{item.name}}</i-col>
                            <i-col span="4">{{item.coupon_type}}</i-col>
                            <i-col span="4">{{item.coupon_expiry_time}}</i-col>
                            <i-col span="4">{{item.expiry_statu}}</i-col>
                            <i-col span="4">{{item.status}}</i-col>
                        </Row>
                    </card>
                </modal>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        CKEDITOR.replace('Couponcontent');
    })
    var crmapp=new Vue({
        el: '#app',
        data: {
            mall_id:'',
            domain:pages_index,
            currentState: 0,
            MemberLevelEdit:false, //会员等级编辑标志位
            MemberCouponEditflag:false, //优惠卷编辑标志位
            modalCouponDetail:false, //优惠卷详情
            Couponflag:true, //优惠卷标志位
            Memberflag:true, //会员标志位
            StatisticsFlag:true, //统计显示标志位
            modalCouponDetailData:{},//优惠卷详情数据
            uploadData:{}, //七牛上传附件参数
            uploadName:'',
            /*uploadUrl:qiniu_upload_url, *///七牛上传地址
            uploadUrl:apiUrl+'file/uploadfile', //七牛上传地址
            uploadList: [], //上传列表
            menuList: ["概览", "发布会员卡", "会员卡管理", "发布代金券", "管理代金券"], //控制导航
            formItemMemberCardImge:'/common/img/card/1.png',
            formItemMember: {
                weid:'',
                levels_name: '',
                conditions: '',
                discount:'',
                money: '0.00',
                card_style:'1',
                card_font_colour:'#000000',
            },
            formItemMemberValidate: {
                levels_name: [
                    {required: true, message: '会员卡名称不能为空', trigger: 'blur'}
                ],
                conditions:[
                    {required: true, message: '会员卡类型不能为空', trigger: 'blur'}
                ],
                discount:[
                    {required: true, message: '会员卡折扣不能为空', trigger: 'blur'}
                ],
                card_style:[
                    {required: true, message: '会员卡样式类型不能为空', trigger: 'blur'},
                ],
            },
            columnsMemberLevel: [
                {
                    title: '会员卡名称',
                    key: 'levels_name',
                    width: 150,
                },
                {
                    title: '会员卡等级',
                    key: 'levels',
                    width: 100,
                },
                {
                    title: '会员卡类型',
                    key: 'conditions',
                    width: 150,
                },
                {
                    title: '折扣率',
                    key: 'discount',
                    width: 100,
                },
                {
                    title: '限制条件',
                    key: 'money',
                    width: 100,
                },
                {
                    title: '添加日期',
                    key: 'created_at',
                    width:180,
                },
                {
                    title: '操作',
                    key: 'action',
                    align: 'center',
                    render: (h, params) => {
                        return h('div', [
                            h('Button', {
                                props: {
                                    type: 'primary',
                                    size: 'small'
                                },
                                style: {
                                    marginRight: '5px'
                                },
                                on: {
                                    click: () => {
                                        crmapp.editMemberLevel(params.row.weid);
                                    }
                                }
                            }, '编辑'),
                        ]);
                    },
                    width:100,
                }
            ],
            MemberLeveldata: [
                {
                    levels_name: '',
                    levels: '',
                    conditions:'',
                    discount: '',
                    money: '',
                    created_at: ''

                }
            ],
            formItemMemberCoupon:{
                weid:'',
                name:'',
                description:'',
                colour:'',
                get_condition:'',
                get_restrict:'1',
                levels:'',
                coupon_type:'',
                amount:'',
                is_reuse:'1',
                use_restrictions:'',
                receive_time:'',
                activity_time:'',
                picture:'',
                title:'',
                content:'',
            },
            formItemMemberCouponlevels: [
                {
                    levels: '',
                }
            ],
            formItemMemberCouponValidate:{
                name:[
                    {required: true, message: '优惠卷名称不能为空', trigger: 'blur'},
                    { min: 1,max: 32,message: '优惠卷名称为1-32位中文字符'},
                ],
                colour:[
                    {required: true, message: '背景色不能为空', trigger: 'blur'},
                ],
                get_condition:[
                    {required: true, message: '优惠卷领取条件不能为空', trigger: 'blur'}
                ],
                get_restrict:[
                    {required: true, message: '领取限制不能为空', trigger: 'blur'},
                    {pattern:/^[1-9]\d*$/, message: '领取限制必须我数值类型'},
                ],
                levels:[
                    {pattern:/^[1-9]\d*$/, message: '会员等级必须为数值类型'},
                ],
                coupon_type:[
                    {required: true, message: '优惠卷类型不能为空', trigger: 'blur'}
                ],
                amount:[
                    {required: true, message: '优惠卷优惠金额不能为空', trigger: 'blur'},
                    {pattern:/^[0-9]+(.[0-9]{1,2})?$/, message: '优惠卷优惠金额格式有误', trigger: 'blur'}
                ],
                is_reuse:[
                    {required: true, message: '其他优惠共同不能为空', trigger: 'blur'}
                ],
                use_restrictions:[
                    {required: true, message: '其他优惠共同不能为空', trigger: 'blur'},
                ],
                receive_time:[
                    { type: 'array', max: 2, message: '优惠卷领取时间段还未选择', trigger: 'change' }
                ],
                activity_time:[
                    {required: true, message: '优惠卷使用期限不能为空', trigger: 'blur'}
                ],
                title:[
                    {required: true, message: '推广标题不能为空', trigger: 'blur'}
                ],
            },
            columnsMemberCouponTotal:1,
            Couponpagesize:10,
            Couponcurrent:1,
            MallMemberList:{
                MallMemberListPageSize:10,
                MallMemberListPageCurrent:1,
                MallMemberListTotal:1,
                MallMemberListflag:false, //显示标志位
                columnsMallMemberList:[
                    {
                        title: '会员姓名',
                        key: 'real_name',
                        width: 100,
                    },
                    {
                        title: '等级',
                        key: 'levels',
                        width: 80,
                    },
                    {
                        title: '等级名称',
                        key: 'levels_name'
                    },
                    {
                        title: '折扣率',
                        key: 'discount',
                        width: 80,
                    },
                    {
                        title: '会员电话',
                        key: 'phone'
                    },
                    {
                        title: '会员消费额',
                        key: 'amount'
                    },
                    {
                        title: '添加日期',
                        key: 'created_at',
                        width: 180,
                    },
                ],
                MallMemberListData:[
                    {
                        real_name: '',
                        levels: '',
                        levels_name:'',
                        discount:'',
                        phone: '',
                        amount: '',
                        created_at: ''
                    }
                ]
            },
            CouponRecordList:{
                CouponRecordListPageSize:10,
                CouponRecordListTotal:1,
                columnsCouponRecordList:[
                    {
                        title: '优惠卷名称',
                        key: 'name',
                        width: 100,
                    },
                    {
                        title: '优惠卷类型',
                        key: 'coupon_type',
                        width: 100,
                    },
                    {
                        title: '优惠金额',
                        key: 'amount',
                        width: 100,
                    },
                    {
                        title: '领取人',
                        key: 'real_name',
                        width: 100,
                    },
                    {
                        title: '电话',
                        key: 'phone',
                        width: 150,
                    },
                    {
                        title: '领取数量',
                        key: 'counts',
                        width: 100,
                    },
                    {
                        title: '过期时间',
                        key: 'coupon_expiry_time',
                        width: 100,
                    },
                    {
                        title: '是否过期',
                        key: 'expiry_statu',
                        width: 100,
                    },
                    {
                        title: '领取日期',
                        key: 'created_at',
                        width: 200,
                    },
                    {
                        title: '操作',
                        key: 'action',
                        align: 'center',
                        render: (h, params) => {
                            return h('div', [
                                h('Button', {
                                    props: {
                                        type: 'primary',
                                        size: 'small'
                                    },
                                    on: {
                                        click: () => {
                                            //查看
                                            crmapp.viewCouponUserRecord(params.row.weid);
                                        }
                                    }
                                }, '查看'),
                            ]);
                        },
                        width: 70,
                    },
                ],
                CouponRecordflag:false, //显示标志位
                CouponRecordListData:[
                    {
                        weid:'',
                        name:'',
                        coupon_type:'',
                        amount:'',
                        real_name:'',
                        phone:'',
                        counts:'',
                        coupon_expiry_time:'',
                        expiry_statu:'',
                        created_at:'',
                    }
                ],
                modalCouponUserRecordDetail:false, //用户领取优惠卷详情标志位
                modalCouponUserRecordDetailData:[], //用户领取优惠卷详情数据
            },
            receive_time_options:{
                disabledDate (date) {
                    return date && date.valueOf() < Date.now() - 86400000;
                }
            },
            columnsMemberCoupon: [
                {
                    title: '优惠卷名称',
                    key: 'name',
                    width: 100,
                },
                {
                    title: '领取条件',
                    key: 'get_condition',
                    width: 100,
                },
                {
                    title: '优惠类型',
                    key: 'coupon_type',
                    width: 100,
                },
                {
                    title: '优惠金额',
                    key: 'amount',
                    width: 100,
                },
                {
                    title: '使用限制',
                    key: 'use_restrictions',
                    width: 100,
                },
                {
                    title: '优惠共同使用',
                    key: 'is_reuse',
                    width: 120,
                },
                {
                    title: '开始领取',
                    key: 'publish_time',
                    width: 120,
                },
                {
                    title: '结束领取',
                    key: 'expire_time',
                    width: 120,
                },
                {
                    title: '可用时间',
                    key: 'activity_time',
                    width: 100,
                },
                {
                    title: '领取量',
                    key: 'receive_num',
                    width: 100,
                },
                {
                    title: '使用量',
                    key: 'use_num',
                    width: 100,
                },
                {
                    title: '添加日期',
                    key: 'created_at',
                    width: 200,
                },
                {
                    title: '操作',
                    key: 'action',
                    align: 'center',
                    render: (h, params) => {
                        //判断是否可以编辑优惠卷开始领取后不可以编辑
                        if(new Date(params.row.publish_time.replace(/-/g,"\/")) < new Date()){
                            return h('div', [
                                h('Button', {
                                    props: {
                                        type: 'primary',
                                        size: 'small'
                                    },
                                    on: {
                                        click: () => {
                                            //查看
                                            crmapp.viewMemberCoupon(params.row.weid);
                                        }
                                    }
                                }, '查看'),
                            ]);
                        }else{
                            return h('div', [
                                h('Button', {
                                    props: {
                                        type: 'primary',
                                        size: 'small'
                                    },
                                    style: {
                                        marginRight: '5px'
                                    },
                                    on: {
                                        click: () => {
                                            //编辑详情
                                            crmapp.editMemberCoupon(params.row.weid);
                                        }
                                    }
                                }, '编辑'),
                                h('Button', {
                                    props: {
                                        type: 'primary',
                                        size: 'small'
                                    },
                                    on: {
                                        click: () => {
                                            //查看
                                            crmapp.viewMemberCoupon(params.row.weid);
                                        }
                                    }
                                }, '查看'),
                            ]);
                        }
                    },
                    width: 150,
                }
            ],
            MemberCoupondata: [

            ],
            option: {
                option1: {
                    title: {
                        text: '年统计'
                    },
                    tooltip: {},
                    legend: {
                        data: ['金额'],
                        left: 'right'
                    },
                    xAxis: {
                        data: []
                    },
                    yAxis: {},
                    series: [{
                        name: '金额',
                        type: 'bar',
                        data: []
                    }]
                },
                option2: {
                    title: {
                        text: '月统计'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: "{a} <br/>{b}: {c} ({d}%)"
                    },
                    legend: {
                        orient: 'vertical',
                        x: 'right',
                        data: ['直接访问', '邮件营销', '联盟广告', '视频广告', '搜索引擎']
                    },
                    series: [
                        {
                            name: '金额',
                            type: 'pie',
                            radius: ['50%', '70%'],
                            avoidLabelOverlap: false,
                            label: {
                                normal: {
                                    show: false,
                                    position: 'center'
                                },
                                emphasis: {
                                    show: true,
                                    textStyle: {
                                        fontSize: '30',
                                        fontWeight: 'bold'
                                    }
                                }
                            },
                            labelLine: {
                                normal: {
                                    show: false
                                }
                            },
                            data: [
                                {value: 335, name: '直接访问'},
                                {value: 310, name: '邮件营销'},
                                {value: 234, name: '联盟广告'},
                                {value: 135, name: '视频广告'},
                                {value: 1548, name: '搜索引擎'}
                            ]
                        }
                    ]
                },
                option3: {
                    title: {
                        text: '日统计'
                    },
                    color: ['#5793f3', '#d14a61', '#675bba'],

                    tooltip: {
                        trigger: 'none',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    legend: {
                        data: ['2015 金额'],
                        left: 'right'
                    },
                    grid: {
                        top: 70,
                        bottom: 50
                    },
                    xAxis: [
                        {
                            type: 'category',
                            axisTick: {
                                alignWithLabel: true
                            },
                            axisLine: {
                                onZero: false,
                                lineStyle: {
                                    color: '#d14a61'
                                }
                            },
                            axisPointer: {
                                label: {
                                    formatter: function (params) {
                                        return '金额  ' + params.value
                                            + (params.seriesData.length ? '：' + params.seriesData[0].data : '');
                                    }
                                }
                            },
                            data: ["2016-1", "2016-2", "2016-3", "2016-4", "2016-5", "2016-6", "2016-7", "2016-8", "2016-9", "2016-10", "2016-11", "2016-12"]
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    series: [
                        {
                            name: '2015 金额',
                            type: 'line',
                            xAxisIndex: 0,
                            smooth: true,
                            data: [2.6, 5.9, 9.0, 26.4, 28.7, 70.7, 175.6, 182.2, 48.7, 18.8, 6.0, 2.3]
                        }
                    ]
                }
            }

        },
        mounted: function () {
            var self = this;
            this.uploadList = this.$refs.upload.fileList;
            this.$nextTick(()=>{

            });
            ajax.get('getQiniuToken').then((res)=>{
                if(res.code==200){
                    this.uploadData.token=res.data;
                    this.uploadData.prefix='pages/crm/';
                }
            });
            //获取商城主键id
            ajax.get('mall/userdetail').then((res)=>{
                if(res.code==200){
                    var date=new Date;
                    var year=date.getFullYear();
                    var month=date.getMonth()+1;
                    month =(month<10 ? "0"+month:month);
                    this.mall_id=res.data.weid;
                    this.InitYear(this.mall_id);
                    //获取当年所有月
                    this.InitMonth(this.mall_id,year);
                    //获取当月所有天
                    this.InitDay(this.mall_id,year+'-'+month);

                }
            });
        },
        watch:{
            currentState:function (val,oldVal) {
                if(val==2){
                    //获取会员等级列表
                    this.InitCurrentStateTwo();
                }
                if(val==1){
                    //判断是否编辑
                    if(this.MemberLevelEdit==true){
                        this.MemberLevelEdit=false;
                    }else{
                        //清空数据信息为重新进入页面
                        this.formItemMember= {
                            weid:'',
                            levels_name: '',
                            conditions: '',
                            discount:'',
                            money: '0.00',
                            card_style:'1',
                            card_font_colour:'#000000',
                        };
                    }
                }
                if(val==3){
                    //获取商城下等级
                    //判断编辑和发布
                    if(this.MemberCouponEditflag==true){
                        this.MemberCouponEditflag=false;
                        this.uploadList = this.$refs.upload.fileList;
                        CKEDITOR.instances.Couponcontent.setData(this.formItemMemberCoupon.content);
                    }else{
                        this.Initlevels();
                        this.uploadList=[];
                        this.uploadList = this.$refs.upload.fileList;
                        CKEDITOR.instances.Couponcontent.setData('');
                        //发布清空数据
                        this.formItemMemberCoupon={
                                weid:'',
                                name:'',
                                description:'',
                                colour:'',
                                get_condition:'',
                                get_restrict:'1',
                                levels:'',
                                coupon_type:'',
                                amount:'',
                                is_reuse:'1',
                                use_restrictions:'',
                                receive_time:'',
                                activity_time:'',
                                picture:'',
                                title:'',
                                content:'',
                        };
                    }
                }
                if(val==4){
                    this.Couponflag=true;
                    this.CouponRecordList.CouponRecordflag=false;
                    //获取优惠卷列表
                    this.InitCouponList(this.Couponpagesize,this.Couponcurrent);
                }

            }
        },
        methods: {
            Initlevels(){
                this.formItemMemberCouponlevels=[];
                ajax.post('member/level/lists', {mall_id:this.mall_id}).then((res)=>{
                    if(res.code==200){
                        if(res.data.total>0){
                            for(var i=0;i<res.data.list.length;i++){
                                this.formItemMemberCouponlevels.push({levels:res.data.list[i].levels});
                            }
                        }
                    }
                });
            },
            InitCurrentStateTwo(){
                var self=this;
                this.Memberflag=true;
                this.MallMemberList.MallMemberListflag=false;
                ajax.post('member/level/lists', {mall_id:self.mall_id}).then((res)=>{
                    if(res.code==200){
                        if(res.data.total>0){
                            self.MemberLeveldata=[];
                            for(var i=0;i<res.data.list.length;i++){
                                var conditions='';
                                if(res.data.list[i].conditions==1)
                                {
                                    conditions='进店自动获取';
                                }
                                if(res.data.list[i].conditions==2)
                                {
                                    conditions='单笔消费满额';
                                }
                                if(res.data.list[i].conditions==3)
                                {
                                    conditions='累计消费满额';
                                }
                                self.MemberLeveldata.push({weid:res.data.list[i].weid,levels_name:res.data.list[i].levels_name,levels:res.data.list[i].levels,conditions:conditions,discount:res.data.list[i].discount,money:res.data.list[i].money,created_at:res.data.list[i].created_at});
                            }
                        }
                    }else{
                        self.$Message.error(res.message);
                    }
                });
            },
            getChart: function (id, option) {
                var op = this.option[option];
                if (op) {
                    var year=echarts.init(document.getElementById(id)).setOption(op);
                }

            },
            handleLevelsmit(name) {
                console.log(this.formItemMember);
                this.$refs[name].validate((valid) => {
                    if (valid) {
                        //判断是否为编辑
                        if(this.formItemMember.weid.length>0){
                            //编辑
                            ajax.post('member/level/update', this.formItemMember).then((res)=>{
                                if(res.code==200){
                                    this.$Message.success('修改成功!');
                                    this.currentState=2;
                                }else{
                                    this.$Message.error(res.message);
                                }
                            });
                        }else{
                            ajax.post('member/level/store', this.formItemMember).then((res)=>{
                                if(res.code==200){
                                    this.$Message.success('添加成!');
                                    this.currentState=2;
                                }else{
                                    this.$Message.error(res.message);
                                }
                            });
                        }
                    }else{
                        this.$Message.error('Fail!');
                    }
                })
            },
            handleCouponmit(name){
                console.log(this.formItemMemberCoupon);
                if(this.uploadList.length<1){
                    this.$Message.error('还未上传推广图片!');
                }
                //判断编辑内容
                if(CKEDITOR.instances.Couponcontent.getData()==""){
                    this.$Message.error('推广内容不能为空!');
                    return false;
                }
                this.formItemMemberCoupon.content=CKEDITOR.instances.Couponcontent.getData();
                this.$refs[name].validate((valid) => {
                    if (valid) {
                        //判断是否为编辑
                        var data={};
                        data.name=this.formItemMemberCoupon.name;
                        data.description=this.formItemMemberCoupon.description;
                        data.colour=this.formItemMemberCoupon.colour;
                        data.get_condition=this.formItemMemberCoupon.get_condition;
                        data.get_restrict=this.formItemMemberCoupon.get_restrict;
                        data.levels=this.formItemMemberCoupon.levels;
                        data.coupon_type=this.formItemMemberCoupon.coupon_type;
                        data.amount=this.formItemMemberCoupon.amount;
                        data.is_reuse=this.formItemMemberCoupon.is_reuse;
                        data.use_restrictions=this.formItemMemberCoupon.use_restrictions;
                        data.publish_time=this.formItemMemberCoupon.receive_time[0];
                        data.expire_time=this.formItemMemberCoupon.receive_time[1];
                        data.activity_time=this.formItemMemberCoupon.activity_time;
                        //data.content_info.picture=this.formItemMemberCoupon.picture;
                        data.content_info={};
                        data.content_info.picture=this.uploadList[0].name;
                        data.content_info.title=this.formItemMemberCoupon.title;
                        data.content_info.content=this.formItemMemberCoupon.content;
                        var time = new Date(data.publish_time);
                        data.publish_time=time.getFullYear() + '-' + (time.getMonth() + 1) + '-' + time.getDate();
                        var time = new Date(data.expire_time);
                        data.expire_time=time.getFullYear() + '-' + (time.getMonth() + 1) + '-' + time.getDate();
                        if(this.formItemMemberCoupon.weid.length>0){
                            //编辑
                            data.weid=this.formItemMemberCoupon.weid;

                            ajax.post('coupon/update', data).then((res)=>{
                                if(res.code==200){
                                    this.$Message.success('编辑成功!');
                                    this.currentState=4;
                                }else{
                                    this.$Message.error(res.message);
                                }
                            });
                        }else{
                            //保存
                            ajax.post('coupon/store', data).then((res)=>{
                                if(res.code==200){
                                    this.$Message.success('添加成!');
                                    this.currentState=4;
                                }else{
                                    this.$Message.error(res.message);
                                }
                            });
                        }
                    }else{
                        this.$Message.error("验证失败");
                    }
                })
            },
            editMemberLevel (index) {
                //请求等级详情
                if(index.length>0){
                    this.formItemMember='';
                    var self=this;
                    ajax.post('member/level/detail', {id:index}).then((res)=>{
                        if(res.code==200){
                            var data={weid:res.data.weid,levels_name:res.data.levels_name,conditions:res.data.conditions,discount:res.data.discount,money:res.data.money,card_style:res.data.card_style,card_font_colour:res.data.card_font_colour};
                            this.formItemMember=data;
                            //类型转换为字符型
                            this.formItemMember.conditions=this.formItemMember.conditions.toString();
                            this.formItemMember.discount=this.formItemMember.discount.toString();
                            this.formItemMember.card_style=this.formItemMember.card_style.toString();
                            this.formItemMemberCardImge='/common/img/card/'+data.card_style+'.png';
                            this.currentState=1;
                            //设置编辑标志位
                            this.MemberLevelEdit=true;
                        }
                    });
                }
            },
            editMemberCoupon (index){
                if(index.length>0){
                    //跳转编辑页
                    this.formItemMemberCoupon='';
                    var self=this;
                    //先获取等级下拉
                    this.Initlevels();
                    ajax.post('coupon/detail', {id:index}).then((res)=>{
                        if(res.code==200){
                            this.currentState=3;
                            this.MemberCouponEditflag=true;
                            //设置编辑标志位
                            var data={};
                            data.weid=res.data.weid;
                            data.name=res.data.name;
                            data.description=res.data.description;
                            data.colour=res.data.colour;
                            res.data.get_condition?data.get_condition=res.data.get_condition.toString():data.get_condition='';
                            res.data.get_restrict?data.get_restrict=res.data.get_restrict.toString():data.get_restrict='';
                            res.data.levels?data.levels=res.data.levels:data.levels='';
                            res.data.coupon_type?data.coupon_type=res.data.coupon_type.toString():data.coupon_type='';
                            res.data.amount?data.amount=res.data.amount.toString():data.amount='';
                            res.data.is_reuse?data.is_reuse=res.data.is_reuse.toString():data.is_reuse='';
                            res.data.use_restrictions?data.use_restrictions=res.data.use_restrictions.toString():data.use_restrictions='';
                            data.receive_time=[res.data.publish_time,res.data.expire_time];
                            res.data.activity_time?data.activity_time=res.data.activity_time.toString():data.activity_time='';
                            this.uploadList[0]={name:res.data.content_info.picture,url:ApiMaterPlatQiniuDomain+res.data.content_info.picture,status:'finished'};
                            data.picture=res.data.content_info.picture;
                            data.title=res.data.content_info.title;
                            data.content=res.data.content_info.content;
                            this.formItemMemberCoupon=data;
                        }
                    });
                }
            },
            viewMemberCoupon (index){
                if(index.length>0){
                    //本页渲染
                    this.modalCouponDetailData='';
                    var self=this;
                    //显示详情
                    ajax.post('coupon/detail', {id:index}).then((res)=>{
                        if(res.code==200){
                            var conditionlist=new Array();
                            conditionlist[1]="用户注册";
                            conditionlist[2]="满足等级";
                            conditionlist[3]="无限制";
                            conditionlist[4]="分享送";
                            var coupon_typelist=new Array();
                            coupon_typelist[1]='现金券';
                            coupon_typelist[2]='折扣券';
                            coupon_typelist[3]='抵用券';
                            var data={};
                            data.name=res.data.name;
                            data.description=res.data.description;
                            data.colour=res.data.colour;
                            data.get_condition=conditionlist[res.data.get_condition];
                            data.coupon_type=coupon_typelist[res.data.coupon_type];
                            data.get_restrict=res.data.get_restrict+'张';
                            data.levels=res.data.levels+'级';
                            data.amount='¥'+res.data.amount+'元';
                            data.use_restrictions='满'+res.data.use_restrictions+'元';
                            res.data.is_reuse==1?data.is_reuse='是':data.is_reuse='否';
                            data.activity_time=res.data.activity_time+'天';
                            data.receive_time=res.data.publish_time + ' ,' + res.data.expire_time;
                            data.title=res.data.content_info.title;
                            data.picture= ApiMaterPlatQiniuDomain+res.data.content_info.picture;
                            data.content=res.data.content_info.content;
                            this.modalCouponDetailData=data;
                            this.modalCouponDetail=true;
                        }
                    });


                }
            },
            viewCouponUserRecord(index){
                if(index.length>0){
                    this.CouponRecordList.modalCouponUserRecordDetail=true;
                    this.CouponRecordList.modalCouponUserRecordDetailData=[];
                    ajax.post('coupon/user/record/mallUserCouponRecordLists', {mall_id:this.mall_id,record_id:index}).then((res)=>{
                        if(res.code==200){
                            for(var i=0;i<res.data.list.length;i++){
                                var list=res.data.list[i];
                                var data={};
                                var coupon_typelist=new Array();
                                coupon_typelist[1]='现金券';
                                coupon_typelist[2]='折扣券';
                                coupon_typelist[3]='抵用券';
                                data.id=i+1;
                                data.name=list.coupon.name;
                                data.coupon_type=coupon_typelist[list.coupon.coupon_type];
                                //过期时间
                                data.coupon_expiry_time=list.coupon_expiry_time;
                                //优惠卷状态
                                var status=new Array();
                                status[1]= '未使用';
                                status[2]= '已使用'
                                status[3]= '已锁定';
                                data.status=status[list.status];
                                //是否过期
                                if(list.expiry_statu==1){
                                    data.expiry_statu='未过期';
                                }else{
                                    data.expiry_statu='已过期';
                                }
                                this.CouponRecordList.modalCouponUserRecordDetailData.push(data);
                            }
                        }
                    })
                }
            },
            CouponPage(index){
                this.InitCouponList(this.Couponpagesize,index);
            },
            InitCouponList(limit,page){
                var self=this;
                ajax.post('coupon/lists', {plat_user_id:plats_user_info.weid,limit:limit,page:page}).then((res)=>{
                    if(res.code==200){
                        if(res.data.total>0){
                            self.MemberCoupondata=[];
                            self.columnsMemberCouponTotal=res.data.total;
                            var conditionlist=new Array();
                            conditionlist[1]="用户注册";
                            conditionlist[2]="满足等级";
                            conditionlist[3]="无限制";
                            conditionlist[4]="分享送";
                            var coupon_typelist=new Array();
                            coupon_typelist[1]='现金券';
                            coupon_typelist[2]='折扣券';
                            coupon_typelist[3]='抵用券';
                            //组合列表
                            for(var i=0;i<res.data.list.length;i++){
                                var list=res.data.list[i];
                                var data={};
                                data.weid=list.weid;
                                data.name=list.name;
                                data.get_condition=conditionlist[list.get_condition];
                                data.coupon_type=coupon_typelist[list.coupon_type];
                                data.amount=list.amount;
                                data.use_restrictions=list.use_restrictions;
                                if(list.is_reuse==1){
                                    data.is_reuse='是';
                                }else{
                                    data.is_reuse='否';
                                }
                                data.publish_time=list.publish_time;
                                data.expire_time=list.expire_time;
                                data.activity_time=list.activity_time;
                                data.receive_num=list.receive_num;
                                data.use_num=list.use_num;
                                data.created_at=list.created_at;
                                self.MemberCoupondata.push(data);
                            }
                        }
                    }else{
                        self.$Message.error(res.message);
                    }
                })
            },
            //统计图加载
            InitYear(mall_id){
                //获取年增长量
                ajax.post('mall/member/statistic/lists', {mall_id:this.mall_id,style:1,limit:100}).then((res)=>{
                    if(res.code==200){
                        if(res.data.total>0){
                            this.option.option1.xAxis.data=[];
                            this.option.option1.series[0].data=[];
                            for(var i=0;i<res.data.list.length;i++){
                                this.option.option1.xAxis.data.push(res.data.list[i].time);
                                this.option.option1.series[0].data.push(res.data.list[i].amount);
                            }
                            var domList = $('.chart-dom');
                            if (domList.length) {
                                domList.each( (key, ele)=> {
                                    if(key==0){
                                        var id = $(ele).attr('id');
                                        var option = $(ele).attr('option');
                                        var op = this.option[option];
                                        if (op) {
                                            var year = echarts.init(document.getElementById(id));
                                            year.setOption(op);
                                            year.on('click', function (params) {
                                                crmapp.InitMonth(mall_id,params.name);
                                            });
                                        }
                                    }
                                })
                            }
                        }else{
                            //没有统计数据
                            this.StatisticsFlag=false;
                        }
                    }
                })
            },
            InitMonth(mall_id,year){
                //月统计
                ajax.post('mall/member/statistic/lists', {mall_id:mall_id,style:2,limit:12,time:year}).then((res)=>{
                    if(res.code==200){
                        if(res.data.total>0){
                            this.option.option2.legend.data=[];
                            this.option.option2.series[0].data=[];
                            for(var i=0;i<res.data.list.length;i++){
                                this.option.option2.legend.data.push(res.data.list[i].time);
                                this.option.option2.series[0].data.push({value: res.data.list[i].amount, name: res.data.list[i].time});
                            }
                            var domList = $('.chart-dom');
                            if (domList.length) {
                                domList.each( (key, ele)=> {
                                    if(key==1){
                                        var id = $(ele).attr('id');
                                        var option = $(ele).attr('option');
                                        var op = this.option[option];
                                        if (op) {
                                            var month = echarts.init(document.getElementById(id));
                                            month.setOption(op);
                                            month.on('click', function (params) {
                                                crmapp.InitDay(mall_id,params.name);
                                            });
                                        }
                                    }
                                })
                            }
                        }
                    }
                })
            },
            InitDay(mall_id,month){
                //日统计
                ajax.post('mall/member/statistic/lists', {mall_id:mall_id,style:3,limit:32,time:month}).then((res)=>{
                    if(res.code==200){
                        if(res.data.total>0){
                            //组合数据
                            this.option.option3.legend.data=[month+' 金额'];
                            this.option.option3.series[0].name=month+' 金额';
                            this.option.option3.series[0].data=[];
                            this.option.option3.xAxis[0].data=[];
                            for(var i=0;i<res.data.list.length;i++){
                                this.option.option3.series[0].data.push(res.data.list[i].amount);
                                this.option.option3.xAxis[0].data.push(res.data.list[i].time);
                            }
                            var domList = $('.chart-dom');
                            if (domList.length) {
                                domList.each( (key, ele)=> {
                                    if(key==2){
                                        var id = $(ele).attr('id');
                                        var option = $(ele).attr('option');
                                        this.getChart(id, option);
                                    }
                                })
                            }
                        }
                    }
                })
            },
            handleRemove (file) {
                const fileList = this.$refs.upload.fileList;
                //同时删除图片
                ajax.post('file/deluploadfile', {imgurl:this.$refs.upload.fileList[0].name}).then((res)=>{});
                this.$refs.upload.fileList.splice(fileList.indexOf(file), 1);
            },
            handleSuccess (res, file) {
                if(res.code==200){
                    file.url = ApiMaterPlatQiniuDomain+res.data.key;
                    file.name = res.data.key;
                }
            },
            handleFormatError (file) {
                this.$Notice.warning({
                    title: '文件类型错误',
                    desc: '文件类型 ' + file.name + ' 不是图片类型'
                });
            },
            handleMaxSize (file) {
                this.$Notice.warning({
                    title: '文件大小',
                    desc: '文件  ' + file.name + ' 文件大小超出2M.'
                });
            },
            handleBeforeUpload () {
                const check = this.uploadList.length < 1;
                if (!check) {
                    this.$Notice.warning({
                        title: '文件超出个数.'
                    });
                }
                return check;
            },
            MallMemberListClick(){
                this.MallMemberListInit(this.MallMemberList.MallMemberListPageSize,1);
            },
            MallMemberListCardClick(){
                this.InitCurrentStateTwo();
            },
            MallMemberListInit(limit,page){
                //获取商城下会员列表
                ajax.post('mall/member/lists', {mall_id:this.mall_id,limit:limit,page:page}).then((res)=>{
                    if(res.code==200){
                        if(res.data.total>0){
                            this.Memberflag=false;
                            this.MallMemberList.MallMemberListflag=true;
                            this.MallMemberList.MallMemberListData=[];
                            this.MallMemberList.MallMemberListTotal=res.data.total;
                            for(var i=0;i<res.data.list.length;i++){
                                var list=res.data.list[i];
                                var data={};
                                data['real_name']=list.real_name;
                                data['levels']=list.level.levels;
                                data['levels_name']=list.level.levels_name;
                                data['discount']=list.level.discount;
                                data['phone']=list.phone;
                                data['amount']=list.amount;
                                data['created_at']=list.created_at;
                                this.MallMemberList.MallMemberListData.push(data);
                            }
                        }
                    }
                })
            },
            MallMemberListPage(index){
                this.MallMemberListInit(this.MallMemberList.MallMemberListPageSize,index);
            },
            CouponRecordListClick(){
                this.CouponRecordListInit(this.CouponRecordList.CouponRecordListPageSize,1);
            },
            CouponListClick(){
                this.Couponflag=true;
                this.CouponRecordList.CouponRecordflag=false;
                //获取优惠卷列表
                this.InitCouponList(this.Couponpagesize,this.Couponcurrent);
            },
            CouponRecordListInit(limit,page){
                //获取商城领取优惠卷记录
                ajax.post('coupon/record/lists', {mall_id:this.mall_id,limit:limit,page:page}).then((res)=>{
                    if(res.code==200){
                        if(res.data.total>0){
                            this.Couponflag=false;
                            this.CouponRecordList.CouponRecordflag=true;
                            this.CouponRecordList.CouponRecordListData=[];
                            this.MallMemberList.CouponRecordListTotal=res.data.total;
                            for(var i=0;i<res.data.list.length;i++){
                                var list=res.data.list[i];
                                var data={};
                                var coupon_typelist=new Array();
                                coupon_typelist[1]='现金券';
                                coupon_typelist[2]='折扣券';
                                coupon_typelist[3]='抵用券';
                                data['weid']=list.weid;
                                data['name']=list.coupon.name;
                                data['coupon_type']=coupon_typelist[list.coupon.coupon_type];
                                data['amount']=list.coupon.amount;
                                data['real_name']=list.user.real_name;
                                data['phone']=list.user.phone;
                                data['counts']=list.counts;
                                data['coupon_expiry_time']=list.coupon_expiry_time;
                                if(list.expiry_statu==1){
                                    data['expiry_statu']='否';
                                }else{
                                    data['expiry_statu']='是';
                                }
                                data['created_at']=list.created_at;
                                this.CouponRecordList.CouponRecordListData.push(data);
                            }
                        }
                    }
                })
            },
            CouponRecordListPage(index){
                this.CouponRecordListInit(this.CouponRecordList.CouponRecordListPageSize,index);
            },
            selectCardStyle(value){
                this.formItemMemberCardImge='/common/img/card/'+value+'.png';
            }
        }
    })
</script>
</body>
</html>