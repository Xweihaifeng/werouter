<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="shortcut icon" id="favicon" href="" />
    <link rel="stylesheet" href="{{PATH_TML}}wepage/css/home.css"/>
    <link rel="stylesheet" href="{{PATH_TML}}wepage/css/common.css"/>
    <script src="{{PATH_TML}}wepage/js/zepto.min.js"></script>
    <script src="{{PATH_TML}}wepage/js/vue.min.js"></script>
    <script src="{{PATH_TML}}wepage/js/layui/layui.all.js"></script>
    <script type="text/javascript" src="{{PATH_CONFIG}}"></script>
    <script src="{{PATH_TML}}wepage/js/home.js"></script>
    <title>激活</title>
</head>
<body style="background: #ffffff; overflow: hidden;">
    <div id="app">
        <div id="login">
            <a :href="backurl"><img id="goback" src="/common/img/return.png" /></a>
            <p>账号激活</p>
            <img id="user" src="/common/img/user.svg" width="20" />
        </div>
        <div id="login-info">
            <ul>
                <li id="phonenum">
                    <span>+86 <img src="/common/img/downarrow.png" alt=""/></span>
                    <input type="text" placeholder="请输入手机号码" maxlength="11" v-model="phone"/>
                </li>
                <li id="checknum">
                    <input type="text" placeholder="请输入手机验证码" maxlength="6" v-model="check"/>
                    <span @click="getCheck">{{ info }}</span>
                </li>
                <li id="forget">
                    <span></span>
                    <span>忘记密码？</span>
                </li>
                <li id="login-bt" @click="login"><p>激活</p></li>
            </ul>
        </div>
    </div>

    <script>
        const getChecknum = (phone) => {
            $.ajax({
                url: CODES,
                dataType: 'json',
                type: 'post',
                data: {'phone': phone},
                success: function(data){
                    console.log(data);
                },
                error: function(err){
                    console.log(err);
                }
            })
        }

        const tologin = (phoneNum, checkNum, weid, token) => {
            $.ajax({
                url:  apiUrl + 'userAct',
                type: 'post',
                headers: {
                    'Token': token
                },
                data: {
                    'phone': phoneNum,
                    'code': checkNum,
                    'weid': weid,
                    'type': 1,
                    'from_type': 2
                    },
                success: function(data){
                    console.log(data);
                    if (data.code == 200) {
                        layer.msg('激活成功', {
                            time: 1500
                        })
                        window.location.href = sessionStorage.getItem('nextPage');
                    } else {
                        layer.msg(data.message, {
                            time: 1500
                        })
                    }
                },
                error: function(err){
                    console.log(err);
                }
            })
        }

        new Vue({
            el: '#app',
            data: {
                phone: '',
                check: '',
                info: '获取验证码',
                lock: false,
                backurl: '',
                isCheck: false,
                weid: '',
                token: ''
            },
            created: function() {
                let self = this;
                self.backurl = sessionStorage.getItem('currentPage');
                self.weid = localStorage.getItem('weid');
                self.token = localStorage.getItem('token');
//                alert(localStorage.getItem('token'))
//                alert(localStorage.getItem('weid'))

                $(".phonenum").keydown(function(evt){
                    switch (evt.keyCode){
                        case 13: $(".checknum").select();
                    }
                });

                $(".checknum").keydown(function(evt){
                    switch (evt.keyCode){
                        case 13: tologin(phone, check, weid, token);
                    }
                });
            },
            methods: {
                getCheck: function() {
                    let self = this;
                    let count = 59;
                    let phonenum = self.phone;
                    if (/^1[3|4|5|7|8][0-9]{9}$/.test(phonenum)) {
                        getChecknum(phonenum);
                        if (!self.lock) {
                            let evt = setInterval(function () {
                                self.lock = true;
                                if (count > 0) {
                                    self.info = count-- + '秒';
                                } else {
                                    self.info = '重新发送验证码';
                                    self.lock = false;
                                    clearInterval(evt);
                                }
                            }, 1000)
                        }
                    } else {
                        layer.msg("请输入正确的手机号码", {
                            time: 1500
                        })
                    }
                },
                login: function() {
                    let self = this;
                    let phonenum = self.phone;
                    let checknum = self.check;
                    if (/^1[3|4|5|7|8][0-9]{9}$/.test(phonenum)) {
                        if (/^[0-9]{6}$/.test(checknum)) { //发送手机和验证码验证成功
                            tologin(phonenum, checknum, self.weid, self.token);
                        } else {
                            layer.msg("手机验证码输入错误", {
                                time: 1500
                            })
                        }
                    } else {
                        layer.msg("请输入正确的手机号码", {
                            time: 1500
                        })
                    }
                }
            }
        })
    </script>
</body>
</html>