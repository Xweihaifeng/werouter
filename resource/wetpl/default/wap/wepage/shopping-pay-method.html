<!--
 * Created by weifeng on 2017/11/12.
-->

<!DOCTYPE html>

<html>

    <head>
        <title> 支付方式 </title>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">

        <link rel="shortcut icon" id="favicon" href="" />
        <link rel="stylesheet" type="text/css" href="{{PATH_TML}}wepage/css/shopping-pay-method.css" />

        <script type="text/javascript" src="{{PATH_TML}}wepage/js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="{{PATH_CONFIG}}"></script>
        <script src="{{PATH_TML}}wepage/js/vue.min.js"></script>
        <script src="{{PATH_TML}}wepage/js/vue-resource.min.js"></script>
        <script src="{{PATH_TML}}wepage/js/layui/layui.all.js"></script>
        <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>

    </head>
	<body>
        <!-- 支付方式头部开始 -->
        <header class="pay_header">
            <nav class="pay_nav">
                <a href="javascript:void(0)" onclick="javascript:history.back(-1)">
                    <li class="pay_icon_img pay_icon_img_clear"></li>
                </a>
                <a href="javascript:void(0)"><li class="pay_nav_title"> 支付方式 </li></a>
                <a href="javascript:void(0)"></a>
            </nav>
        </header>
        <!-- 支付方式头部结束 -->

        <!-- 支付方式内容开始 -->
        <section class="pay_section" id="pay_section">
			<slide class="pay_order background">
				<slide class="pay_order_img"></slide>
				<slide class="pay_order_info">
					<li> 订单号：{{order_detail.order_num}} </li>
					<li> 网上支付订单等待支付 </li>
					<li> 您共需支付：<em>￥</em><span>{{order_detail.order_price}}</span> </li>
				</slide>
			</slide>
			<slide class="pay_wechat">
				<slide class="pay_wechat_img background"></slide>
				<slide class="pay_wechat_title"> 微信支付 <span class="pay_recommend"> 推荐 </span> </slide>
				<slide class="pay_wechat_select pay_select"></slide>
			</slide>
			<slide class="pay_immediately">
				<a href="javascript:void(0)" @click="order_pay"> 立即支付 </a>
			</slide>
		</section>

        <script>
            // 全局请求添加token
            Vue.http.headers.common['token'] = window.localStorage.getItem("token");

            // 创建vue根实例
            var app = new Vue({
                el: "#pay_section",
                data: {
                    address_default : JSON.parse(window.sessionStorage.getItem('address_default')),
                    store_num: window.location.pathname.split("/").pop(),
                    order_detail: '',
                    config: ''
                },
                mounted: function() {
                    // 获取默认地址
                    var self = this;
                    self.$http.get(apiUrl + 'order/detail/' + self.store_num).then(function (data) {
                        this.order_detail = data.data.data;
                        console.log(this.order_detail);
                    });

                    // var openid = window.location.search.split("&").pop().split("=").pop();
                    // var body1 = new Object();
                    // var openid = window.location.search.split("=").pop();
                    // body1.order_id = "3ab772d0-cf79-11e7-9bf4-8173ba741f45";
                    // body1.openid   = "oBAbkwEfrEdh4oiK3IBs6fclRVwA";
/*                    var body1 = {
                        order_id: self.store_num,
                        openid  : window.location.search.split("=").pop()
                    };
                    // body1.order_id = self.store_num;
                    // body1.openid   = openid;
                    alert("微信openid", body1);
                    self.$http.post(apiUrl + 'pages/wechatPay/mallOrderPhonePay', body1).then(function (data) {
                        var result = data.data.data.config;

                        wx.config({
                            // debug: true， // 开启调试模式，调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                            appId: result.appId， // 必填，公众号的唯一标识
                            timestamp: result.timestamp， // 必填，生成签名的时间戳
                            nonceStr: result.nonceStr， // 必填，生成签名的随机串
                            signature: result.paySign，// 必填，签名，
                            jsApiList: ["chooseWXPay"]//必填，需要使用的JS接口列表(权限)，所有JS接口列表下面会给出本人已经摘录好的!!!
                        });

                        wx.ready(function(){
                            wx.chooseWXPay({
                                appId    : result.appId,     // 时间戳
                                timestamp: result.timestamp, // 时间戳
                                nonceStr : result.nonceStr,  // 签名字符串
                                package  : result.package,   // 包数据
                                signType : result.signType,  // 签名加密方式
                                paySign  : result.paySign,   // 支付签名
                                success  : function (res) {  // 支付成功后的回调函数
                                    layer.msg("交易成功！", { time: 1500 });
                                }
                            });
                        });
                    });*/
                    // if(!openid) {
                    //     alert("缺失openid", openid);
                    //     return false;
                    // } else {
                    // }    



                    var body1 = {
                        order_id: self.store_num,
                        openid  : window.location.search.split("=").pop()
                    };
                    // body1.order_id = self.store_num;
                    // body1.openid   = openid;
                    alert("微信openid", body1);
                    self.$http.post(apiUrl + 'pages/wechatPay/mallOrderPhonePay', body1).then(function (data) {
                        this.config = data.data.data.config;

                        var onBridgeReady = function() {
                            if (res.err_msg == "get_brand_wcpay_request:ok") {
                                MessageBox.alert(commonToast["paySuccess"]).then(action => {
                                    //支付成功 回到首页
                                    alert("支付成功");
                                });
                            } else if (res.err_msg == "get_brand_wcpay_request:cancel") {
                                //取消支付!
                                alert("取消支付");
                            } else {
                                alert("未知");
                            }
                        }

                        if (typeof WeixinJSBridge == "undefined") {
                            if (document.addEventListener) {
                                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                            } else if (document.attachEvent) {
                                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                            }
                        } else {
                            WeixinJSBridge.invoke('getBrandWCPayRequest', {
                                "appId"    : this.config.appId,     // 时间戳
                                "timestamp": this.config.timestamp, // 时间戳
                                "nonceStr" : this.config.nonceStr,  // 签名字符串
                                "package"  : this.config.package,   // 包数据
                                "signType" : this.config.signType,  // 签名加密方式
                                "paySign"  : this.config.paySign,   // 支付签名
                            }, function (res) {
                                onBridgeReady();
                            })
                        }
                    });
                },
                ready: function() {

                },
                computed : {

                },
                methods : {
                    order_pay: function() {
                        // Mall - 商城 - 下单页返回openid
                        var self = this;
                        var body = new Object();
                        body.url = window.location.href;
                        body.orderid = self.store_num;
                        window.location.href = apiUrl + 'mall/getMallOpenid?url=' + window.location.href + '&orderid=' + self.store_num;

                        // window.location.href = encodeURI(globalHost + '/openid?url=' + window.location.href);
                    }
                }
            })
        </script>
	</body>
</html>