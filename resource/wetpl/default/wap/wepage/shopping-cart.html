<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>购物车页面</title>

    <link rel="stylesheet" href="{{PATH_TML}}wepage/css/shopping-cart.css">

    <script src="{{PATH_TML}}wepage/js/jquery-3.2.1.min.js"></script>
    <script src="{{PATH_TML}}wepage/js/vue.min.js"></script>
    <script src="{{PATH_TML}}wepage/js/vue-resource.min.js"></script>

</head>
<body>
<div id="shopCart">
    <header>
        <span>购物车</span>
        <a class="back" href="javascript:void(0)" onclick="javascript:history.back(-1)"></a>
    </header>
    <div class="main">
        <div class="address">
                    <span>
                        <img src="{{PATH_TML}}wepage/img/location.png" alt="">
                        西安
                    </span>
            <span>编辑商品</span>
        </div>

        <div class="store" v-for="(store,pIndex) in list">
            <div class="name">
                <label class="circle" :class="{'checked-item-circle' : store.mall.pCheck}" :for="pIndex"><input
                        @click="selectStore(store);" v-model="store.mall.pCheck" :id="pIndex" :value="pIndex"
                        type="checkbox"></label>
                <p>
                    <i></i>
                    <span>{{store.mall.title}}</span>
                </p>
            </div>
            <ul>
                <li v-for="(item,index) in store.goods">
                    <label class="circle" :class="{'checked-item-circle' : item.checked}" :for="pIndex+''+index">
                        <input @click="selectItem(store,item,index)" v-model="item.checked" class="circle"
                               :id="pIndex+''+index" type="checkbox"></label>
                    <img :src="'http://images.new.wezchina.com/' + item.cover" alt="">
                    <div class="product">
                        <p class="des">{{item.title}}</p>
                        <p class="price">
                            <span>{{item.price * item.selectNum ? item.price * item.selectNum : item.price}}</span>
                            <label>
                                <span @click="operNum(item,store,'reduce')">-</span>
                                <span>{{item.selectNum ? item.selectNum : 1}}</span>
                                <span @click="operNum(item,store,'add')">+</span>
                            </label>
                        </p>
                        <p class="operation">
                            <span>删除</span>
                            <span>移入关注</span>
                        </p>
                    </div>
                </li>
            </ul>
            <div class="store-count">
                <p>
                    <span>
                        总计：
                        <strong>￥{{store.storeAllMoney ? store.storeAllMoney : 0.00}}</strong>
                    </span>
                    <span>总额￥{{store.storeAllMoney ? store.storeAllMoney : 0.00}} 立减￥0.00</span>
                </p>
                <a :class="{'red-bg' : store.storeAllMoney>0}">去结算
                    <small>({{store.num ? store.num : 0}})件</small>
                </a>
            </div>
        </div>
    </div>
</div>

<script>

    var app = new Vue({
        el: "#shopCart",
        data: {
            list: []
        },
        mounted: function () {
            this.$http.get('{{PATH_TML}}wepage/mock/cart.json').then(function (res) {
                this.list = res.data.data.list;
            })
        },
        methods: {
            getNumber : function (storeObj,flag) {
                storeObj.storeAllMoney = 0.00;
                storeObj.num = 0;
                var len = storeObj.goods.length;
                for (var i = 0; i < len; i++) {
                    if(flag){
                        storeObj.goods[i].checked = storeObj.mall.pCheck;
                    }
                    if (storeObj.goods[i].checked) {
                        storeObj.storeAllMoney += storeObj.goods[i].price * storeObj.goods[i].selectNum;
                        storeObj.num++
                    }
                }
            },
            selectStore: function (storeObj) {
                storeObj.mall.pCheck = !storeObj.mall.pCheck;
                this.getNumber(storeObj,true)
            },
            selectItem: function (storeObj, itemObj, index) {
                itemObj.checked = !itemObj.checked;
                var isAllCheck = storeObj.goods.filter(function (item) {
                    return item.checked === false;
                });
                storeObj.mall.pCheck = (isAllCheck.length === 0);
                this.getNumber(storeObj)

            },
            operNum: function (item, storeObj,oper) {
                item.checked = true;
                if(oper === "add"){
                    item.selectNum++;
                    if (item.selectNum > item.stock) {
                        item.selectNum = item.stock
                    }
                }
                if(oper === "reduce"){
                    item.selectNum--;
                    if (item.selectNum <= 0) {
                        item.selectNum = 1;
                    }
                }

                var isAllCheck = storeObj.goods.filter(function (item) {
                    return item.checked === false;
                });
                storeObj.mall.pCheck = (isAllCheck.length === 0);
                this.getNumber(storeObj)
            }
        }
    })
</script>
</body>
</html>