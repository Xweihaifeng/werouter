<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title></title>
    <link rel="stylesheet" href="{{PATH_TML}}wepage/lib/weui.css" />
    <link rel="stylesheet" href="{{PATH_TML}}wepage/css/info.css"/>
    <script src="{{PATH_TML}}wepage/lib/jquery.min.js"></script>
	<script src="{{PATH_CONFIG}}"></script>
	<script src="{{PATH_TML}}wepage/js/vue.min.js"></script>
</head>
<body>
<div id="app" class="box">
	<div class="myInfo">
		<span class="img"><img :src="avatar" alt=""/></span>
		<span>
			<p class="name">{{nickname}}</p>
			<p class="wid">WEID：{{domain}}</p>
		</span>
	</div>
	<div class="des">
		<div>
			<label>功能介绍</label>
			<span style="display:inline-block;width: 73%;">{{motto}}</span>
		</div>
		<div class="img-div">
			<label>账号主体</label>
			<span><img src="/common/img/idcard.png" width="25" alt=""/>{{account}}</span>
		</div>
		<div class="cert">
			<label>认证信息</label>
			<span>{{cert}}</span>
		</div>
		<!--<div>
			<label>所在地</label>
			<span style="padding-left: 0.13rem;">陕西&nbsp;&nbsp;西安</span>
		</div>-->
	</div>

	<div class="des">
		<div class="work">
			<label>经营范围</label>
			<span>{{work}}</span>
		</div>
	</div>
	
	<!--<div class="user_select">
		<div>
			<label>接收文章推送</label>
            <input class="weui-switch" type="checkbox" checked="checked"/>
		</div>
		<div>
			<label>置顶公众号</label>
			<input class="weui-switch" type="checkbox"/>
		</div>
	</div>-->
	<div class="des">
		<div>
		<label>
			<a :href="wepage">我的微主页</a>
		</label>
		</div>
		<div>
		<label>
			<a>查看历史消息</a>
		</label>
		</div>
		<div class="wecard">
		<label>
			<a>查看我的微名片</a>
		</label>
		</div>
	</div>

	<div class="des">
		<div>
			<label>
				<a>申请查看手机号</a>
			</label>
		</div>
	</div>


	<!--<div class="history" style="display: flex;">
		<label>
			功能模块
		</label>
		<label style="display: flex">
			<img src="{{PATH_TML}}wepage/img/tb2.png" alt=""/>
			<img src="{{PATH_TML}}wepage/img/tb3.png" alt=""/>
			<img src="{{PATH_TML}}wepage/img/tb4.png" alt=""/>
			<img src="{{PATH_TML}}wepage/img/tb5.png" alt=""/>
		</label>
	</div>-->
	<div class="foot">
		<div>
			<p class="enter" >关注</p>
			<p>投诉</p>
		</div>		
	</div>
</div>	
<script>
	const init = function(url, ref) {
		$.ajax({
			url: url,
			type: 'get',
			success: function(data){
				console.log(data);
				if (data.data.user.avatar != null) {
					ref.avatar = 'http://images.new.wezchina.com/' + data.data.user.avatar;
				}
				$('title').text(data.data.user.nickname + '的微名片')
				ref.nickname = data.data.user.nickname;
				ref.domain = data.data.user.domain;
				ref.motto = data.data.user.motto;

				let title = ref.nickname;
				let summary = ref.motto;
				let cover = ref.avatar;

				if (is_weixn()) {
					var oldTime = localStorage.getItem('setopenid-date');
					if (!isExpire(oldTime)) { //没过期
						//var usertoken = localStorage.getItem('user-token');
						var usertoken = localStorage.getItem('setopenid');
						if (usertoken == 'true') {
							openid = getUrlParam("openid");
							//微信登录
							$.ajax({
								url: apiUrl + 'wxlogin',
								type: 'POST',
								data: {
									openid: openid,
								},
								success: function (data) {
									if (data.code == 200) {
										if (isNull(data.token) == false) { //非空
											localStorage.setItem('token-date', new Date().getTime())
											localStorage.setItem('user-token', data.token);
										}
									}
								}
							})
						}
					} else {
						//微信未跳转时
						localStorage.setItem('setopenid', true);
						localStorage.setItem('setopenid-date', new Date().getTime())
						window.location.href = encodeURI(apiUrl + '/openid?url=' + window.location.href);
					}
				}

				$.ajax({
					url: apiUrl + 'wxjssdk',
					type: 'POST',
					data: {
						currenturl: window.location.href
					},
					success: function(data) {
						if (data.code == 200) {
							console.log(data)
							wx.config({
								debug: false,
								appId: data.data.appId,
								timestamp: data.data.timestamp,
								nonceStr: data.data.nonceStr,
								signature: data.data.signature,
								jsApiList: ["onMenuShareTimeline", "onMenuShareAppMessage"]
							});

							wx.ready(function() {
								var link = window.location.href;
								alert('cover:', cover)
								wx.onMenuShareTimeline({
									title: title,
									// 分享标题
									link: link,
									// 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
									desc: summary,
									//分享描述
									imgUrl: cover,
									// 分享图标
									success: function() {
										// 用户确认分享后执行的回调函数
									},
									cancel: function() {
										// 用户取消分享后执行的回调函数
									}
								});
								wx.onMenuShareAppMessage({
									title: title,
									// 分享标题
									desc: summary,
									// 分享描述
									link: link,
									// 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
									imgUrl: cover,
									// 分享图标
									type: '',
									// 分享类型,music、video或link，不填默认为link
									dataUrl: '',
									// 如果type是music或video，则要提供数据链接，默认为空
									success: function() {
										// 用户确认分享后执行的回调函数
									},
									cancel: function() {
										// 用户取消分享后执行的回调函数
									}
								});
							})
						}
					}
				})
			}
		})
	}

	//获取参数
	function getUrlParam(name) {
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
		var r = window.location.search.substr(1).match(reg); //匹配目标参数
		if (r != null) return unescape(r[2]);
		return null; //返回参数值
	}

	//判断为空
	function isNull(data) {
		return (data == "" || data == undefined || data == null || data == 'null') ? true: false;
	}

	//判断是否在微信中打开
	function is_weixn() {
		var ua = navigator.userAgent.toLowerCase();
		if (ua.match(/MicroMessenger/i) == "micromessenger") {
			return true;
		} else {
			return false;
		}
	}

	//检查openid是否过期(有效期1天)
	const isExpire = function(oldTime) {
		var day = 86400000;
		var now = new Date().getTime();
		if (oldTime != null) {
			if (now - oldTime < 86400000) {
				return false;
			} else {
				localStorage.removeItem('setopenid-date')
				localStorage.removeItem('user-token')
				return true;
			}
		} else {
			return true;
		}
	}

	new Vue({
		el: '#app',
		data: {
			avatar: '',
			nickname: '',
			domain: '',
			account: '个人',
			cert: '官方认证',
			motto: '暂无内容',
			work: '互联网',
			wepage: ''
		},
		created: function(){
			var _self = this;
			var platuserid = window.location.pathname.split('/')[2];
			init(apiUrl + 'circel/wcard/' + platuserid, _self);
		},
		methods: {
			care: function(){
				var _self = this;
				$(".enter").text("进入公众号");
			}
		}
	})
</script>
</body>
</html>