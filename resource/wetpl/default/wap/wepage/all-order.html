<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title> 我的订单 </title>

    <link href="{{PATH_TML}}wepage/css/all-order.css" rel="stylesheet">

    <script src="{{PATH_TML}}wepage/js/jquery-3.2.1.min.js"></script>
    <script src="{{PATH_CONFIG}}"></script>
    <script src="{{PATH_TML}}wepage/js/vue.min.js"></script>
    <script src="{{PATH_TML}}wepage/js/vue-resource.min.js"></script>
    <script type="text/javascript" src="/common/layer-v3.0.3/layer-v3.0.3/layer/layer.js"></script>
</head>
<body>
<div id="order-app" v-cloak>
    <header>
        <span> 我的订单 </span>
        <a class="back" href="javascript:void(0)" onclick="javascript:history.back(-1)"></a>
    </header>
    <div class="order-container">
        <div class="singleOrder" v-for="order in orderList">
            <div class="order-number">
                <span>订单号：{{order.order_num}}</span>
                <i>×</i>
            </div>
            <div class="order-status">
                <div>
                    <p>状态：{{getStatus(order.order_status)}}</p>
                    <p>总价：￥{{order.order_price}}</p>
                </div>
                <a v-for="item in operList(order.order_status)" @click="operation(item.oper,order)">{{item.text}}</a>
            </div>
            <div class="order-detail" v-for="good in order.goods">
                <img :src="'http://images.new.wezchina.com/'+good.goods_cover" alt="">
                <div>
                    <p>{{good.goods_summary}}</p>
                    <p>{{good.goods_num}}件</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
//    Vue.http.headers.common['token'] = 'eyJpdiI6IlwvTFZlRU5lQ2FlMHE3MW16dkFmNUVnPT0iLCJ2YWx1ZSI6Ijc2ZWt3M1o5U2RcL2tWNTlYazBSVDVsMDIwaHpcL2dWZ2VwSVY1V2hib3o0RmxTMzBvU2o1SEMyZ2U2UjRVV0xielFBWlROb1ArbGhyRTY3VHBXTlwvenZwUXF6aHBpUmROeFJJNE5CRUh2YyswPSIsIm1hYyI6ImIzYjBiYzM2YjBlMjkxNDAzMjZlYzM5YWJmMWNhOGEzMDJkY2FjMzFiNGQwMGM0NGFlYTRkMTVlMzNhZGU1N2EifQ=='

    Vue.http.headers.common['token'] = window.localStorage.getItem("token");
    var commentApp = new Vue({
        el : "#order-app",
        data : {
            orderList : []
        },
        mounted : function () {
            this.init();
        },
        methods : {
            init : function () {
                var data = {
                    "plat_user_id" : window.localStorage.getItem('weid')
//                    "plat_user_id" : 'aafc6a60-c2b6-11e7-804f-2b2e90492ab4'
                };
                this.$http.post(apiUrl+'order/list',data).then(function (res) {
                    console.log(res);
                    if(res.data && res.data.code === 200){
                        this.orderList = res.data.data.list
                    }
                })
            },
            getStatus : function (num) {
                if(num){
                    switch (num){
                        case 1:
                            return '已下单';
                        case 2:
                            return '已付款';
                        case 3:
                            return '已发货';
                        case 4:
                            return '已签收';
                        case 5:
                            return '已评价';
                        case 6:
                            return '已取消';
                        case 7:
                            return '已完成';
                        case 8:
                            return '已退款';
                        case 9:
                            return '已确认退款';
                    }
                }
            },
            operList : function (num) {
                if(num){
                    switch (num){
                        case 1:
                            return [
                                {
                                    text : '去付款',
                                    oper : 'pay'
                                },
                                {
                                    text : '取消订单',
                                    oper : 'cancel'
                                }
                            ];
                        case 3:
                            return [
                                {
                                    text : '确认收货',
                                    oper : 'takeOrder'
                                },
                                {
                                    text : '查看物流',
                                    oper : 'distribution'
                                }
                            ];
                        case 4:
                            return [
                                {
                                    text : '去评价',
                                    oper : 'comment'
                                },
                                {
                                    text : '确认交易',
                                    oper : 'deal'
                                },
                                {
                                    text : '退款',
                                    oper : 'refund'
                                }
                            ];
                        case 5:
                            return [
                                {
                                    text : '确认交易',
                                    oper : 'deal'
                                },
                                {
                                    text : '退款',
                                    oper : 'refund'
                                }
                            ];
                        case 6:
                            return [
                                {
                                    text : '删除订单',
                                    oper : 'delete'
                                }
                            ];
                        case 7:
                            return [
                                {
                                    text : '删除订单',
                                    oper : 'delete'
                                }
                            ];
                        case 9:
                            return [
                                {
                                    text : '删除订单',
                                    oper : 'delete'
                                }
                            ];
                    }
                }
            },
            operation : function (oper,order) {
                if(oper){
                    switch (oper){
                        case 'pay':
                            this.pay();
                            break;
                        case 'cancel':
                            this.cancel(order);
                            break;
                        case 'takeOrder':
                            this.takeOrder(order);
                            break;
                        case 'distribution':
                            this.distribution(order);
                            break;
                        case 'comment':
                            this.comment();
                            break;
                        case 'deal':
                            this.deal();
                            break;
                        case 'refund':
                            this.refund();
                            break;
                        case 'delete':
                            this.delete(order);
                            break;
                    }
                }
            },
//            取消订单
            cancel : function (order) {
                var self = this;
                var data = {
                    "order_id" : order.weid
                };
                layer.confirm('确认取消该条订单吗？', {
                    title: false,
                    btn: ['确定','取消']
                }, function(index){
                    self.$http.post(apiUrl+'order/cancel',data).then(function (res) {
                        if(res.data && res.data.code === 200){
                            layer.close(index);
                            this.init();
                        }else{
                            layer.msg('取消订单失败');
                        }
                    })
                });

            },
//            删除订单
            delete : function (order) {
                var self = this;
                var data = {
                    "order_id" : order.weid
                };
                layer.confirm('确认删除该条订单吗？', {
                    title: false,
                    btn: ['确定','取消']
                }, function(index){
                    self.$http.post(apiUrl+'order/delete',data).then(function (res) {
                        console.log(res);
                        if(res.data && res.data.code === 200){
                            layer.close(index);
                            this.init();
                        }else{
                            layer.msg('删除订单失败');
                        }
                    })
                });
            },
//            确认收货
            takeOrder : function (order) {
                var data = {
                    "order_id" : order.weid
                };
                this.$http.post(apiUrl+'order/take',data).then(function (res) {
                    console.log(res);
                    if(res.data && res.data.code === 200){
                        layer.msg("已收货");
                        this.init();
                    }else{
                        layer.msg('删除订单失败');
                    }
                });
            },
//            查看物流
            distribution : function (order) {
                this.$http.get('order/detail/{id}').then(function (res) {

                })
            },
//            评价
            comment : function (order) {

            },
//            确认交易
            deal : function (order) {
                var data = {
                    "order_id" : order.weid
                };
                this.$http.post(apiUrl+'order/ok',data).then(function (res) {
                    console.log(res);
                    if(res.data && res.data.code === 200){
                        layer.msg("交易成功");
                        this.init();
                    }else{
                        layer.msg('确认交易失败');
                    }
                });
            },
//            退款
            refund : function (order) {
                var data = {
                    "order_id" : order.weid
                };
                this.$http.post(apiUrl+'order/refund',data).then(function (res) {
                    console.log(res);
                    if(res.data && res.data.code === 200){
                        layer.msg("申请退款成功");
                        this.init();
                    }else{
                        layer.msg('申请退款失败');
                    }
                });
            },
//            付款
            pay : function (order) {

            }
        }
    });

</script>
</body>
</html>