<html>

<head>
    <meta charset="UTF-8">
    <title></title>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta name="format-detection" content="telephone=no">
    <meta content="email=no" name="format-detection">
    <link rel="shortcut icon" id="fav" href="" />
    <link rel="stylesheet" href="{{PATH_TML}}vote/static/icon/iconfont_1.css">
    <link rel="stylesheet" type="text/css" href="{{PATH_TML}}vote/css/modal.css">
    <style>
        .alert {
            text-align: center;
            z-index: 20000;
            color: #fff;
            background: rgba(0, 0, 0, 0.5);
            height: 46px;
            line-height: 46px;
            border: none;
            position: fixed;
            top: 0;
            width: 35%;
            border-radius: 5px;
        }

        .modal-title {
            font-size: 14px;
            display: block;
            margin-top: -2px;
        }
    </style>
    <link rel="stylesheet" href="{{PATH_TML}}vote/css/bootstrap.css">
    <style></style>

<body>
<div class="wxalert alert-danger" role="alert" id="message-top" style="display: none;"></div>
<script type="text/javascript" src="/common/art-template.js"></script>
<link rel="stylesheet" href="{{PATH_TML}}vote/css/mui.min.css">
<link rel="stylesheet" href="{{PATH_TML}}vote/layui/css/layui.css">
<link rel="stylesheet" href="{{PATH_TML}}vote/iconfont/iconfont.css">
<link rel="stylesheet" href="{{PATH_TML}}vote/font/iconfont.css">
<link rel="stylesheet" href="/common/jquery.animsition/css/animsition.min.css">
<style>
    body {
        background-color: #fff;
    }

    .iconfont {
        font-size: 15px;
        margin-right: 5px;
    }

    img {
        width: 100%;
    }

    /*标题*/

    .vote-title {
        margin: 10px 10px 20px;
        font-size: 16px;
        color: #333;
    }

    .vote-statistics {
        text-align: center;
        background-color: #e60000;
        margin: 0 10px;
        border-radius: 5px;
        color: #fff;
        padding: 7px 0;
        font-size: 12px;
    }

    .vote-statistics-1 {
        display: block;
    }

    .vote-statistics-2 {
        display: block;
        margin-top: 5px;
    }

    .vote-statistics-border {
        border-left: 1px solid;
        border-right: 1px solid;
    }

    .condition-1 {
        margin: 25px 10px 0;
    }

    .condition-2 {
        margin-top: 10px;
    }

    .condition-2 a {
        color: #337ab7;
    }

    .condition-3 {
        display: none;
        margin-top: 10px;
    }

    .condition-3 a {
        color: #337ab7;
    }

    .icon-downarrow {
        font-weight: bold;
        color: #e60000;
        margin-left: -4px;
        cursor: pointer;
    }

    .icon-toparrow {
        font-weight: bold;
        color: #e60000;
        cursor: pointer;
        margin-left: -4px;
    }

    .search-1 {
        margin: 20px 10px 5px;
    }

    .search-2 {
        padding-right: 10px;
    }

    .search-2 input {
        margin-bottom: 0;
        height: 30px;
        line-height: 30px;
    }

    .search-3 {
        height: 30px;
        padding: 0 15px;
        background-color: #e60000;
    }

    .search-3:active {
        background-color: #ec7063;
    }

    .search-3 i {
        font-size: 14px;
    }

    /*投票列表*/

    .vote-box {
        margin: 0 10px;
    }

    .vote-list:nth-child(2n+1) {
        padding-right: 5px;
        margin-top: 15px;
    }

    .vote-list:nth-child(2n) {
        padding-right: 5px;
        margin-top: 15px;
    }

    .vote-list-bgc {
        background-color: #ececec;
    }

    @media screen and (max-width: 320px) {
        .vote-list-bgc img {
            height: 98px;
        }
    }

    @media screen and (max-width: 375px) and (min-width: 321px) {
        .vote-list-bgc img {
            height: 117px;
        }
    }

    @media screen and (max-width: 414px) and (min-width: 376px) {
        .vote-list-bgc img {
            height: 130px;
        }
    }

    .vote-list-title {
        padding: 10px 10px 0;
        color: #333;
        height: 48px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
    }

    .vote-list-btn {
        text-align: center;
        margin-top: 10px;
        padding: 0 10px;
    }

    .vote-list-btn button {
        width: 100%;
        color: #fff;
        padding: 3px 0;
        background-color: #e60000;
    }

    .vote-list-btn button:hover {
        background-color: #c70202;
    }

    .vote-list-btn a {
        width: 85%;
        color: #fff;
        padding: 3px 0;
        background-color: #e60000;
        display: block;
        margin: 0 auto;
        border-radius: 3px;
    }

    .vote-list-btn button:active {
        background-color: #ec7063;
    }

    .vote-list-btn a:active {
        background-color: #ec7063;
    }

    .vote-list-btn button i {
        font-size: 14px;
    }

    .vote-list-btn a i {
        font-size: 14px;
    }

    .vote-list-num {
        text-align: center;
        padding: 10px;
        color: #333;
    }

    /*底部信息*/

    .vote-footer-box {
        color: #666;
        text-align: center;
        background-color: #F5F5F5;
        padding: 20px 0;
    }

    .vote-footer-link {
        margin-top: 10px;
    }

    .vote-footer-link a {
        color: #666;
    }

    /*登录弹框*/

    .modal .modal-dialog {
        margin-top: 50%;
        width: 80%;
        margin-left: 10%;
    }

    .modal .input-w {
        height: 206px;
        border-radius: 6px;
        display: block;
        width: initial;
        margin-top: initial;
        margin-left: initial;
        position: initial;
    }

    .modal .input1 {
        margin-top: 30px;
        height: 40px;
        border: none;
        border-radius: 4px;
        padding-left: 8px;
        margin-bottom: 0;
    }

    .modal .input2 {
        width: 52%;
        height: 40px;
        border: none;
        border-radius: 4px;
        padding-left: 8px;
        margin-bottom: 0;
    }

    .modal .input3 {
        height: 39px;
        background-color: #ff605d;
        color: #fff;
        font-size: 14px;
        width: 44%;
        margin-top: 10px;
    }

    /*操作栏*/

    .home {
        position: fixed;
        bottom: 120px;
        right: 0;
        background-color: #ec5f38;
        color: #fff;
        height: 40px;
        width: 40px;
        text-align: center;
        border-radius: 2px;
        padding-top: 4px;
    }

    .home a {
        color: #fff;
    }

    .home span {
        display: block;
        font-size: 12px;
    }

    .paiming {
        position: fixed;
        bottom: 75px;
        right: 0;
        background-color: #F7B824;
        color: #fff;
        height: 40px;
        width: 40px;
        text-align: center;
        border-radius: 2px;
        padding-top: 4px;
    }

    .paiming a {
        color: #fff;
    }

    .paiming span {
        display: block;
        font-size: 12px;
    }

    .guize {
        position: fixed;
        bottom: 30px;
        right: 0;
        background-color: #24b5f7;
        color: #fff;
        height: 40px;
        width: 40px;
        text-align: center;
        border-radius: 2px;
        padding-top: 4px;
    }

    .guize a {
        color: #fff;
    }

    .guize span {
        display: block;
        font-size: 12px;
    }

    /*点击查看全文*/

    #click {
        display: block;
        text-align: center;
        margin-top: 10px;
    }

    /*广告位*/

    .ad-box {
        padding: 0 10px;
        margin-top: 20px;
    }

    .ad-img {
        margin-bottom: 5px;
    }

    /*加载更多*/

    .layui-flow-more {
        margin-top: 20px;
        width: 100%;
        display: inline-block;
    }

    @font-face {
        font-family: 'iconfont';
        src: url('{{PATH_TML}}vote/font/iconfont.eot');
        src: url('{{PATH_TML}}vote/font/iconfont.eot?#iefix') format('embedded-opentype'),
        url('{{PATH_TML}}vote/font/iconfont.woff') format('woff'),
        url('{{PATH_TML}}vote/font/iconfont.ttf') format('truetype'),
        url('{{PATH_TML}}vote/font/iconfont.svg#iconfont') format('svg');
    }

    .iconfont {
        font-family: "iconfont" !important;
        font-size: 16px;
        font-style: normal;
        -webkit-font-smoothing: antialiased;
        -webkit-text-stroke-width: 0.2px;
        -moz-osx-font-smoothing: grayscale;
    }
</style>

<script type="text/javascript">
    template.helper('imgc', function(val) {
        return ApiMaterPlatQiniuDomain + val;
    });
</script>

<script type="text/html" id="tml_ads">
    {{each adv as val key}}
    <div class='mui-col-sm-12 mui-col-xs-12 ad-img'><a href='{{val.url}}'><img src='{{val.image | imgc}}' ></a></div>
    {{/each}}
</script>

<script type="text/html" id="tml_vote">
    <div class="mui-col-xs-6 mui-col-sm-6 vote-list">
        <div class="vote-list-bgc">
            <a href="/vote/show/{{item.weid}}">
                <img id="place" class="lazy-{{key}}" src="{{lazy_cover}}" data-original="{{item_cover}}" alt="" />
            </a>
            <div class="vote-list-title">{{item.sort}}.{{item.title }}</div>
            <div class="vote-list-btn"><button id='{{item.sort}}.{{item.title}}' data-original="{{item_cover}}" data-sort="{{item.sort}}" data-title="{{item.title}}" data-id="{{item.weid}}">
                <i class="iconfont icon-zan"></i>投票</button></div>
            <div class="vote-list-num">
                <font>{{item.nums}}</font>票</div>
        </div>
    </div>
</script>

<!--头部大图-->
<div class="indexapp animsition">
    <div class="hidden_wechat" :value="only_wechat" style="display:none;"></div>
    <div id="cover">
        <img v-bind:src="cover" class="lazy-cover" alt="封面"></div>
    <!--标题-->
    <div class="vote-title ">{{title}}</div>
    <div class="mui-row vote-statistics indexapp">
        <div class="mui-col-sm-4 mui-col-xs-4">
            <span class="vote-statistics-1">参与{{appellation}}</span>
            <span class="vote-statistics-2 indexapp">{{countitem}}</span></div>
        <div class="mui-col-sm-4 mui-col-xs-4 vote-statistics-border">
            <span class="vote-statistics-1">累计投票</span>
            <span class="vote-statistics-2 ">{{num}}</span></div>
        <div class="mui-col-sm-4 mui-col-xs-4">
            <span class="vote-statistics-1">访问次数</span>
            <span class="vote-statistics-2 ">{{views}}</span></div>
    </div>
    <div class="mui-row condition-1">
        <div class="mui-col-sm-12 mui-col-xs-12">
            <i class="iconfont icon-shizhong1"></i>开始时间：{{begin_time}}</div>
        <div class="mui-col-sm-12 mui-col-xs-12 condition-2">
            <i class="iconfont icon-shizhong1"></i>截止时间：{{end_time}}</div>
        <div class="mui-col-sm-12 mui-col-xs-12 condition-2">
            <i class="iconfont icon-jinggao1"></i>投票规则： {{rule}}</div>
        <div class="mui-col-sm-12 mui-col-xs-12 condition-2">
            <i class="iconfont icon-huodong1"></i>投票简介：
            <i class="iconfont icon-downarrow"></i></div>
        <div class="mui-col-sm-12 mui-col-xs-12 condition-3">{{summary}}
            <a :href="checkurl" id="click">查看全文</a></div>
    </div>
    <!--<form class="mui-row search-1" method="get" action="">-->
    <div class="mui-row search-1">
        <div class="mui-col-sm-8 mui-col-xs-8 search-2">
            <input type="text" name="key" id="search_key" value="" placeholder="请输入项目编号或名称">
        </div>
        <div class="mui-col-sm-4 mui-col-xs-4">
            <button class="mui-btn mui-btn-danger search-3">
                <i class="iconfont icon-sousuo"></i>搜索
            </button>
        </div>
    </div>
    <!--</form>-->
    <!--投票列表-->
    <div class="mui-row vote-box" id="vote_list"></div>
    <!--广告位-->
    <div class="mui-row ad-box"></div>
    <!--底部信息-->
    <div class="mui-row vote-footer-box">
        <div class="mui-col-sm-12 mui-col-xs-12 vote-footer-link">
            <a v-bind:href="support_link" target="_blank">{{support_text}}</a>&nbsp;提供技术支持
            <!--登录弹框-->
            <div class="modal modall" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="input-w">
                            <input type="number" id="mobile" placeholder="请输入您的手机号码" name="mobile" class="input1" value="">
                            <input type="number" name="old_auth_code" placeholder="请输入验证码" class="input2" value="">
                            <input id="btnSendCode" type="button" value="获取验证码" class="input3">
                            <button type="button" class="btn2 save-code">立即投票</button>
                            <!--存放登录前选择投票的该项目-->
                            <input type="text" value="" class="openid" style="display: none;"></div>
                    </div>
                </div>
            </div>
            <!--操作栏-->
            <!-- <div class="home">
<a :href="indexurl" target="_blank">
  <span>返回</span>
  <span>首页</span>
</a>
</div> -->
            <div class="paiming">
                <a :href="rankurl">
                    <span>当前</span>
                    <span>排名</span></a>
            </div>
            <div class="guize">
                <a :href="checkurl">
                    <span>投票</span>
                    <span>规则</span></a>
            </div>
        </div>
</body>

</html>
<script src='{{PATH_TML}}vote/js/vue.min.js'></script>
<script src='{{PATH_TML}}vote/js/jquery1.4.3.min.js'></script>
<script>
    $(function() {
        $(function() {
            $(".animsition").animsition({

                inClass: 'fade-in',
                outClass: 'fade-out',
                inDuration: 1500,
                outDuration: 800,
                linkElement: '.animsition-link',
                loading: true,
                loadingParentElement: 'body', //animsition wrapper element
                loadingClass: 'animsition-loading',
                unSupportCss: ['animation-duration',
                    '-webkit-animation-duration',
                    '-o-animation-duration'
                ],
                overlay: false,
                overlayClass: 'animsition-overlay-slide',
                overlayParentElement: 'body'
            });
        });
    });
    //禁止用户右键点击
    /*jQuery(document).ready(function(){
     jQuery(document).bind("contextmenu",function(e){
     return false;
     });
     });*/
</script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="{{PATH_TML}}vote/layui/layui.js"></script>
<script src="{{PATH_TML}}vote/js/jquery.lazyload.min.js"></script>
<script src="/common/jquery.animsition/js/jquery.animsition.min.js"></script>
<script src={{PATH_TML}}vote/js/config.js></script>
<script>
    // 分享模板关键字替换
    var STMP = {
        TMP: {
            index: '我投了{{number}}号"{{name}}"{{showname}}一票，"{{votename}}"投票火热进行中，快来围观，参与投票吧！',
            detail: '我为{{number}}号"{{name}}"{{showname}}带盐，欢迎各位朋友前来围观，请支持TA，投上您宝贵的一票！',
        },
        tmp_variant: {
            votename: '我的投票',
            number: '1',
            name: '投票',
            showname: '项目'
        }
    };

    function templaten(string, MX) {
        for (prop in MX) {
            string = string.replace(new RegExp('{{' + prop + '}}', 'gm'), MX[prop]);
        }
        return string;
    }

    //获取参数
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg); //匹配目标参数
        if (r != null) return unescape(r[2]);
        return null; //返回参数值
    }

    //判断为空
    function isNull(data) {
        return (data == "" || data == undefined || data == null || data == 'null') ? true : false;
    }

    var globalWeid;
    var href = window.location.href;
    var path = window.location.pathname.split('/');
    var len = path.length;
    if (href.indexOf('from') != -1) {
        globalWeid = href.split('?')[0].split('/').pop()
    } else {
        globalWeid = path.pop();
        if (globalWeid == '') {
            globalWeid = path[len - 2];
            localStorage.setItem('vote-id', globalWeid);
        }
    }

    var lazy_cover = "/common/img/vote_front_cover.png";
    var now_time = Math.round(new Date().getTime() / 1000);
    var enter;
    var vm = new Vue({
        el: '.indexapp',
        data: {
            title: '',
            summary: '',
            cover: '/common/img/vote_front_cover.png',
            num: '',
            views: '',
            begin_time: '',
            end_time: '',
            only_wechat: '',
            status: '',
            remark: '',
            statistic: '',
            countitem: '',
            rule: '',
            adv: '',
            list: [],
            total: '',
            page: 1,
            checkurl: '',
            rankurl: '',
            indexurl: '',
            appellation: '',
            support_text: '',
            support_link: ''
        },
        created: function() {
            var _self = this;
            var voteid = globalWeid;
            $.ajax({
                url: globalHost + '/vote/detail/' + globalWeid,
                type: 'GET',
                success: function(data) {
                    if (data.code == 200) {
                        // 投票分享标题
                        STMP.TMP.index = data.data.share_title_index,
                                STMP.TMP.detail = data.data.share_title_detail,
                                STMP.tmp_variant.votename = data.data.title,
                                STMP.tmp_variant.showname = data.data.appellation,
                                _self.title = data.data.title;
                        _self.countitem = data.data.countitem;
                        _self.num = data.data.num;
                        _self.views = data.data.views;
                        _self.cover = data.data.cover.indexOf('//') != -1 ? data.data.cover : ApiMaterPlatQiniuDomain + data.data.cover;
                        _self.summary = data.data.summary;
                        _self.begin_time = data.data.begin_time;
                        _self.end_time = data.data.end_time;
                        _self.rule = data.data.rule;
                        _self.adv = data.data.adv;
                        _self.appellation = data.data.appellation;
                        _self.support_text = data.data.support_text;
                        _self.support_link = data.data.support_link;


                        data.data.qiniu = ApiMaterPlatQiniuDomain;
                        var $add = template('tml_ads', data.data);


                        if (data.data.cover_default != null) {
                            lazy_cover = ApiMaterPlatQiniuDomain + data.data.cover_default;
                            // console.log('lazy_cover:', lazy_cover)
                        }

                        jQuery('.ad-box').html($add);
                        var fav = data.data.favicon;
                        if (fav.indexOf('http') === -1) {
                            fav = ApiMaterPlatQiniuDomain + fav;
                        }
                        $("#fav").attr("href", fav);

                        //打开方式 
                        _self.only_wechat = data.data.only_wechat;
                        _self.checkurl = "/vote/rule/" + globalWeid;
                        _self.rankurl = "/vote/report/" + globalWeid;
                        _self.indexurl = "/vote/" + globalWeid;

                        sessionStorage.setItem('title', _self.title);
                        $("title").text(_self.title);

                        isopeninwechat(_self.only_wechat);

                        jQuery(".lazy-cover").lazyload({
                            // 图片淡入效果
                            effect: "fadeIn",
                            // 加载前的默认图片
                            placeholder: lazy_cover,
                        });
                    }
                }
            })
        }
    })
    //判断是否在微信中打开
    function is_weixn() {
        var ua = navigator.userAgent.toLowerCase();
        if (ua.match(/MicroMessenger/i) == "micromessenger") {
            return true;
        } else {
            return false;
        }
    }
    //判断是否在微信中打开
    function isopeninwechat(flag) {
        var hidden_wechat = flag;
        var pc = getUrlParam('pc');
        if (!is_weixn()) {
            if (hidden_wechat == 1) {
                if (isNull(pc)) {
                    window.location.href = "/vote/warn";
                }
            }
        }
    }

    //检查openid是否过期(有效期1天)
    var isExpire = (oldTime) => {
        var day = 86400000;
        var now = new Date().getTime();
        if (oldTime != null) {
            if (now - oldTime < 86400000) {
                return false;
            } else {
                localStorage.removeItem('setopenid-date')
                localStorage.removeItem('user-token')
                return true;
            }
        } else {
            return true;
        }
    }

    $(function() {
        //判断在微信中打开直接登录
        if (is_weixn()) {
            var oldTime = localStorage.getItem('setopenid-date');
            // var openidflag = localStorage.getItem('setopenid');
            //setopenid不为空时
            // if (isNull(openidflag) == false) {
            if (!isExpire(oldTime)) { //没过期
                // alert("未过24小时")
                var usertoken = localStorage.getItem('user-token');

                if (isNull(usertoken) || usertoken == undefined || usertoken == '') {
                    // alert("usertoken 过期")
                    openid = getUrlParam("openid");
                    //获取来源首页进入
                    // alert("openid:" + openid)
                    var comeweid = '';
                    comeweid = 'vote/' + globalWeid;
                    // alert(openid + "-/-" + ref_url + "-/-" + type + "-/-" + vote_id + "-/-" + item_id)
                    //微信登录
                    $.ajax({
                        url: globalHost + '/vote/wxlogin',
                        type: 'POST',
                        data: {
                            openid: openid,
                            ref_url: comeweid,
                            type: 1,
                            vote_id: globalWeid,
                            item_id: 'item_id'
                        },
                        success: function(data) {

                            // alert("TOKEN")
                            if (data.code == 200) {
                                if (isNull(data.token) == false) { //非空
                                    // alert("获取usertoken:", data.token)
                                    localStorage.setItem('token-date', new Date().getTime())
                                    localStorage.setItem('user-token', data.token);
                                }
                            }
                        }
                    })
                }
            } else {
                // alert("已过24小时")
                //微信未跳转时
                // localStorage.setItem('setopenid', true);
                localStorage.setItem('setopenid-date', new Date().getTime())
                window.location.href = encodeURI(globalHost + '/openid?url=' + window.location.href);
            }
        }
        //初始化layerui
        layui.use(['layer', 'laypage', 'element'],
                function() {
                    var layer = layui.layer
                });
        //下拉折叠
        jQuery(document).on('click', '.icon-downarrow',
                function() {
                    jQuery('.condition-3').css('display', 'block');
                    jQuery(this).removeClass('icon-downarrow').addClass('icon-toparrow');
                });
        jQuery(document).on('click', '.icon-toparrow',
                function() {
                    jQuery('.condition-3').css('display', 'none');
                    jQuery(this).removeClass('icon-toparrow').addClass('icon-downarrow');
                });

        // 异步加载投票列表数据
        var limit = 6;
        var i = 1; //ajax成功计数
        var lock = false; //init lock
        var pages_total = 1; //init total page
        var mem = 1; //out page
        var lists;
        var isScroll = false;
        var isSuccess = false;

        var nextPage = (lis, voteid, limit, page, key, next) => {
            $.ajax({
                url: globalHost + '/vote/list',
                type: 'POST',
                data: {
                    vote_id: voteid,
                    limit: limit,
                    page: page,
                    keywords: key
                },
                success: function(data) {
                    if (data.code == 200) {
                        // console.log(data)
                        lists = data.data;
                        isSuccess = true;
                    }
                }
            })
        }

        var fast = (lists, lis, page, next) => {
            // console.log(lists);
            pages_total = Math.ceil(lists.total / limit);

            layui.each(lists.list,
                    function(index, item) {
                        var item_val = [];
                        item_val['item'] = item;
                        item_val['key'] = i;
                        item_val['lazy_cover'] = lazy_cover;
                        item_val['item_cover'] = item.cover.indexOf('//') != -1 ? item.cover : ApiMaterPlatQiniuDomain + item.cover + '?/3/w/170/h/130/interlace/1/format/webp';
                        var vote_tml = template('tml_vote', item_val);
                        lis.push(vote_tml);
                    });
            next(lis.join(''), page < pages_total);
            // // 图片懒加载
            jQuery(".lazy-" + i).lazyload({
                // 图片淡入效果
                effect: "fadeIn",
                // 加载前的默认图片
                placeholder: lazy_cover
            });
            i++;
        }

        layui.use('flow',
                function() {
                    var flow = layui.flow;
                    // 信息流
                    flow.load({
                        elem: '#vote_list' // 指定列表容器
                        ,
                        isAuto: true,
                        isLazyimg: true,
                        done: function(page, next) { // 到达临界点（默认滚动触发），触发下一页
                            var lis = [];
                            var voteid = globalWeid;
                            var key = sessionStorage.getItem("key");
                            if (key == null) {
                                key = '';
                            }

                            if (i > 1) {
                                limit = 4;
                                page = page + 0.5;
                                mem = page;
                            };

                            var loadFast = (page, next) => {
                                $('.layui-flow-more').html('<div class="layui-flow-more"><a href="javascript:;"><i class="layui-anim layui-anim-rotate layui-anim-loop layui-icon iconfont" style="color: #8a8a8a;">&#xe77f;</i></a></div>')
                                var success = setInterval(function() {
                                    if (isSuccess) {
                                        isSuccess = false;
                                        fast(lists, [], page, next);
                                        clearInterval(success);
                                    }
                                }, 10);
                            }

                            // console.log('out page:', page)
                            // console.log('mem:', mem)

                            isScroll = false;

                            nextPage(lis, voteid, limit, page, key, next);

                            //init
                            if (!lock) {
                                lock = true;
                                loadFast(page, next);
                                isScroll = true;
                            }

                            if (page < pages_total) {
                                $('.layui-flow-more').html('<div class="layui-flow-more"><a href="javascript:;"><cite id=' + page + '>加载更多</cite></a></div>')
                            } else {
                                $('.layui-flow-more').html('<div class="layui-flow-more">没有更多了</div>')
                            }

                            if (!isScroll) {
                                isScroll = true;
                                window.onscroll = function() {
                                    var clientHeight = document.documentElement.scrollTop === 0 ? document.body.clientHeight : document.documentElement.clientHeight;
                                    var scrollTop = document.documentElement.scrollTop === 0 ? document.body.scrollTop : document.documentElement.scrollTop;
                                    var scrollHeight = document.documentElement.scrollTop === 0 ? document.body.scrollHeight : document.documentElement.scrollHeight;
                                    if (clientHeight + scrollTop === scrollHeight && page < pages_total) {
                                        // console.log('inner page:', page)
                                        // console.log('bottom')
                                        // console.log('i:', i)

                                        if (i == (mem - 0.5)) {
                                            loadFast(page, next);
                                        } else {
                                            // console.log('error page', page)
                                            var check = setInterval(function() {
                                                if (i == (mem - 0.5)) {
                                                    loadFast(page, next);
                                                    clearInterval(check);
                                                }
                                            }, 10)
                                        }
                                    }
                                }
                            }

                            $("cite").click(function() {
                                var lis = [];
                                // console.log('clicked')
                                // console.log('i:', i)
                                // console.log('clicked page:', page);
                                loadFast(page, next);
                            })
                        }
                    });
                    // 图片懒加载
                    flow.lazyimg();
                });

        //投票
        jQuery(document).on('click', '.vote-list-btn button',
                function() {
                    //显示登录弹框
                    // alert('vm.only_wechat:' + vm.only_wechat)
                    if (!is_weixn() && vm.only_wechat == 1) {
                        layer.msg("请扫描二维码在微信中投票", {
                            time: 1500,
                            offset: '350px'
                        });
                        return false;
                    }
                    if (vm.status == 2) {
                        layer.msg("投票项目关闭", {
                            time: 1500,
                            offset: '350px'
                        });
                        return false;
                    }
                    var begin_time = Date.parse(new Date(vm.begin_time));
                    begin_time = begin_time / 1000;
                    if (now_time < begin_time) {
                        layer.msg("本投票活动未开放投票", {
                            time: 1500,
                            offset: '350px'
                        });
                        return false;
                    }
                    var end_time = Date.parse(new Date(vm.end_time));
                    end_time = end_time / 1000;
                    if (now_time > vm.end_time) {
                        layer.msg("本投票活动未开放投票", {
                            time: 1500,
                            offset: '350px'
                        });
                        return false;
                    }
                    var user = localStorage.getItem('user-token');

                    var vote_id = jQuery(this).data('id');
                    if ((isNull(user) || user == undefined || user == '') && !is_weixn()) { /////////////////////
                        // $('#myModal2').modal();
                        layer.msg("请扫描二维码在微信中投票", {
                            time: 1500,
                            offset: '350px'
                        });
                        jQuery('.openid').attr('value', vote_id);
                    } else {
                        // alert(1)
                        //投票
                        var now_obj = jQuery(this);
                        var now_num = jQuery(this).parent().next().find('font').text(); // 列表中的投票数量
                        var now_num1 = jQuery('.after-num').text(); // 标题栏中的投票数量
                        var after_num = parseInt(now_num) + 1;
                        var after_num1 = parseInt(now_num1) + 1;
                        $.ajaxSetup({
                            global: true,
                            dataType: 'json',
                            headers: {
                                'Token': user
                            }
                        });
                        $.ajax({
                            url: globalHost + '/vote/voted',
                            type: 'POST',
                            data: {
                                item_id: vote_id
                            },
                            success: function(data) {
                                // alert('data.code isn\'t 200')
                                if (data.code == 200) {
                                    if (isNull(data.data) == false) {
                                        // alert('data.data is not null')
                                        now_obj.parent().next().find('font').text(after_num); // 列表中的投票数量
                                        jQuery('.after-num').text(after_num1); // 标题栏中的投票数量
                                        layer.msg("投票成功", {
                                            time: 1500,
                                            offset: '350px'
                                        });

                                        vm.title = sessionStorage.getItem('title');
                                        var obj = vm;
                                        // 分享标题
                                        STMP.tmp_variant.name = now_obj.data('title');
                                        STMP.tmp_variant.number = now_obj.data('sort');
                                        var title = templaten(STMP.TMP.index, STMP.tmp_variant);
                                        $("title").text(title);
                                        // alert(now_obj.data('original'));
                                        // alert(obj.cover);
                                        var img = now_obj.data('original');
                                        // alert('vote cover:', img);
                                        initWx(obj, img, 0, title);
                                    }
                                } else {
                                    // alert('data.data is null')
                                    layer.msg(data.message, {
                                        time: 1500,
                                        offset: '350px'
                                    });
                                }
                            },
                            error: function(xhr) {
                                layer.msg(xhr, {
                                    time: 1500,
                                    offset: '350px'
                                });
                            }
                        })
                    }
                    // alert('out')
                });
    });

    //第三方统计
    setTimeout(function() {
                var statistic = vm.statistic;
                if (statistic) {
                    eval(statistic);
                }
            },
            10000);

    $.ajax({
        url: globalHost + '/wxjssdk',
        type: 'POST',
        data: {
            currenturl: window.location.href
        },
        success: function(data) {
            if (data.code == 200) {
                wx.config({
                    debug: false,
                    appId: data.data.appId,
                    timestamp: data.data.timestamp,
                    nonceStr: data.data.nonceStr,
                    signature: data.data.signature,
                    jsApiList: ["onMenuShareTimeline", "onMenuShareAppMessage"]
                });

                wx.ready(function() {
                    setTimeout(function() {
                        var img = vm.cover;
                        // alert('init cover:' + img);
                        initWx(vm, img, 0, vm.title);
                    }, 200);
                })
            }
        }
    })

    //微信分享
    function initWx(data, img, id, title) {
        var link = 'http://' + window.location.host + '/' + "vote/" + globalWeid;
        // alert('wx cover:' + img)
        // alert('wx summary:' + data.summary)
        // alert('wx link:' + link)
        wx.onMenuShareTimeline({
            title: title,
            // 分享标题
            link: link,
            // imgUrl: data.detail.cover,
            // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            // imgUrl: ApiMaterPlatQiniuDomain + data.cover,
            desc: data.summary,
            //分享描述

            imgUrl: img,
            // 分享图标
            success: function() {
                // 用户确认分享后执行的回调函数
            },
            cancel: function() {
                // 用户取消分享后执行的回调函数
            }
        });
        wx.onMenuShareAppMessage({
            title: title,
            // 分享标题
            // desc: data.summary,
            // imgUrl: data.detail.cover,
            desc: data.summary,
            // 分享描述
            link: link,
            // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            // imgUrl: ApiMaterPlatQiniuDomain + data.cover,

            imgUrl: img,
            // 分享图标
            type: '',
            // 分享类型,music、video或link，不填默认为link
            dataUrl: '',
            // 如果type是music或video，则要提供数据链接，默认为空
            success: function() {
                // 用户确认分享后执行的回调函数
            },
            cancel: function() {
                // 用户取消分享后执行的回调函数
            }
        });
    }

    var search = function() {
        $("#vote_list").html('');
        var voteid = globalWeid;
        var key = $("#search_key").val();
        sessionStorage.setItem("key", key);
        // 异步加载投票列表数据
        layui.use(['layer', 'laypage', 'element'],
                function() {
                    var layer = layui.layer
                });

        var limit = 6;
        var i = 1; //ajax成功计数
        var lock = false; //init lock
        var pages_total = 1; //搜索功能
        var mem = 1;
        var lists;
        var isScroll = true;
        var isSuccess = false;

        var nextPage = (lis, voteid, limit, page, key, next) => {
            $.ajax({
                url: globalHost + '/vote/list',
                type: 'POST',
                data: {
                    vote_id: voteid,
                    limit: limit,
                    page: page,
                    keywords: key
                },
                success: function(data) {
                    if (data.code == 200) {
                        // console.log(data)
                        lists = data.data;
                        isSuccess = true;
                    }
                }
            })
        }

        var fast = (lists, lis, page, next) => {
            // console.log(lists);
            pages_total = Math.ceil(lists.total / limit);
            layui.each(lists.list,
                    function(index, item) {
                        var item_val = [];
                        item_val['item'] = item;
                        item_val['key'] = i;
                        item_val['lazy_cover'] = lazy_cover;
                        item_val['item_cover'] = item.cover.indexOf('//') != -1 ? item.cover : ApiMaterPlatQiniuDomain + item.cover + '?/3/w/170/h/130/interlace/1/format/webp';
                        var vote_tml = template('tml_vote', item_val);
                        lis.push(vote_tml);
                    });
            next(lis.join(''), page < pages_total);
            // 图片懒加载
            jQuery(".lazy-" + i).lazyload({
                // 图片淡入效果
                effect: "fadeIn",
                // 加载前的默认图片
                placeholder: lazy_cover
            });
            i++;
        }

        layui.use('flow',
                function() {
                    var flow = layui.flow;
                    // 信息流
                    flow.load({
                        elem: '#vote_list' // 指定列表容器
                        ,
                        isAuto: true,
                        isLazyimg: true,
                        done: function(page, next) { // 到达临界点（默认滚动触发），触发下一页
                            var lis = [];
                            var voteid = globalWeid;
                            // var key = sessionStorage.getItem('key');
                            // if (key == null) {
                            //   key = '';
                            // }

                            if (i > 1) {
                                limit = 4;
                                page = page + 0.5;
                                mem = page;
                            };

                            var loadFast = (page, next) => {
                                $('.layui-flow-more').html('<div class="layui-flow-more"><a href="javascript:;"><i class="layui-anim layui-anim-rotate layui-anim-loop layui-icon iconfont">&#xe77f;</i></a></div>')
                                var success = setInterval(function() {
                                    if (isSuccess) {
                                        isSuccess = false;
                                        fast(lists, [], page, next);
                                        clearInterval(success);
                                    }
                                }, 10);
                            }

                            // console.log('out page:', page)
                            // console.log('mem:', mem)

                            isScroll = false;

                            nextPage(lis, voteid, limit, page, key, next);

                            //init
                            if (!lock) {
                                lock = true;
                                loadFast(page, next);
                                isScroll = true;
                            }

                            if (page < pages_total) {
                                $('.layui-flow-more').html('<div class="layui-flow-more"><a href="javascript:;"><cite id=' + page + '>加载更多</cite></a></div>')
                            } else {
                                $('.layui-flow-more').html('<div class="layui-flow-more">没有更多了</div>')
                            }

                            if (!isScroll) {
                                isScroll = true;
                                window.onscroll = function() {
                                    var clientHeight = document.documentElement.scrollTop === 0 ? document.body.clientHeight : document.documentElement.clientHeight;
                                    var scrollTop = document.documentElement.scrollTop === 0 ? document.body.scrollTop : document.documentElement.scrollTop;
                                    var scrollHeight = document.documentElement.scrollTop === 0 ? document.body.scrollHeight : document.documentElement.scrollHeight;
                                    if (clientHeight + scrollTop === scrollHeight && page < pages_total) {
                                        // console.log('inner page:', page)
                                        // console.log('bottom')
                                        // console.log('i:', i)

                                        if (i == (mem - 0.5)) {
                                            loadFast(page, next);
                                        } else {
                                            // console.log('error page', page)
                                            var check = setInterval(function() {
                                                if (i == (mem - 0.5)) {
                                                    loadFast(page, next);
                                                    clearInterval(check);
                                                }
                                            }, 10)
                                        }
                                    }
                                }
                            }

                            $("cite").click(function() {
                                var lis = [];
                                // console.log('clicked')
                                // console.log('i:', i)
                                // console.log('clicked page:', page);
                                loadFast(page, next);
                            })
                        }
                    });
                    // 图片懒加载
                    flow.lazyimg();
                });
    }

    $(".search-3").click(function() {
        search();
    })

    $("#search_key").keydown(function(evt) {
        switch (evt.keyCode) {
            case 13:
                search();
        }
    });
</script>