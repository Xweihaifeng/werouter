<#extend#>public/domain/domain_extend.html</#extend#>
<link href="{{PATH_TML}}css/edit-comment.css" rel="stylesheet">

<script type="text/javascript">
    show.header = 'no';
    show.footer = 'no';
</script>

<header>
    <span> 发表评价 </span>
    <a class="back" href="javascript:void(0)" onclick="javascript:history.back(-1)"></a>
</header>
<div class="comment-container">
    <div class="commit-btn" @click="submitComment()">提交</div>
    <div v-for="(item, index) in orderObj.goods">
        <div class="good">
            <img :src="ApiMaterPlatQiniuDomain+item.goods_cover" alt="">
            <span>商品评分</span>
            <span v-for="star in item.starList" class="star" :class="{'not-red' : !star.check}" @click="goStar(item,star)"></span>
        </div>
        <textarea placeholder="在这里分享使用商品的体验吧~" v-model="item.comment"></textarea>
        <!--
        <div class="col-sm-10 form-group addimgmore">
            <div class="imglabel">
                <div :id="'container_'+index" style="position: relative;">
                    <a class="btn btn-default btn-lg btn-file" :id="'pickfiles_more_'+index" href="#" @click="InitQiNiv(index)" style="position: relative; z-index: 1;"> <span>上传图片</span> </a>
                    <div id="html5_1c2e16ctg57v1adh18ko1q7n15jv3_container" class="moxie-shim moxie-shim-html5" style="position: absolute; top: 0px; left: 14px; width: 88px; height: 38px; overflow: hidden; z-index: 0;">
                        <input id="html5_1c2e16ctg57v1adh18ko1q7n15jv3" type="file" style="font-size: 999px; opacity: 0; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" multiple="" accept="" />
                    </div>
                </div>
            </div>
            <div style="display:none" id="success" class="col-md-12">
                <div class="alert-success">
                    队列全部文件处理完毕
                </div>
            </div>
            <div class="imgmore" style="padding-left: 15px;">
                <div class="imgsdiv">
                    <div :id="'fsUploadProgress_'+index"></div>
                </div>
            </div>
        </div>
        -->

    </div>
</div>
</div>
<script>
    new Vue({
        el : "#app",
        data : {
            orderObj : {}
        },
        mounted:function () {
            var originData = JSON.parse(window.localStorage.getItem('orderObj'));
            for(var i=0; i< originData.goods.length;i++){
                var arr = [];
                for(var a=0;a<5;a++){
                    var obj = {};
                    obj.id = a;
                    obj.check = true;
                    arr.push(obj)
                }
                originData.goods[i].starList = arr;
                originData.goods[i].comment = '';
            }
            this.orderObj = originData;
        },
        methods :{
            goStar : function (item,star) {
                star.check = !star.check;
                if(star.check){
                    //该位置的index值是几，红色星星选到几
                    for(var i=0; i<=star.id;i++){
                        item.starList[i].check = true;
                    }
                }else{
                    //如果取消打星，则将从index+1开始到最后的星星置灰
                    star.check = true;
                    for(var i=star.id+1;i<=4;i++){
                        item.starList[i].check = false;
                    }
                }
            },
            submitComment : function () {
                for(var a=0; a<this.orderObj.goods.length; a++){
                    var sendObj = {
                        order_id : this.orderObj.weid,
                        data : []
                    };
                    var obj = {};
                    obj.goods_id = this.orderObj.goods[a].goods_id;
                    obj.order_id = this.orderObj.weid;
                    obj.title = '';
                    obj.content = this.orderObj.goods[a].comment;
                    if(obj.content==''){
                        layer.open({
                            content: '评论内容不能为空！'
                            ,skin: 'msg'
                            ,time: 2
                        });
                        return false;
                    }
                    var arr = this.orderObj.goods[a].starList.filter(function (s) {
                        return s.check === true;
                    });
                    obj.grade = arr.length;
                    sendObj.data.push(obj);
                    this.sendRequest(sendObj)
                }
            },
            sendRequest : function (data) {
                ajax.post('goods/comment/store', data).then((res)=>{
                    if(res.code==200){
                        layer.open({
                            content: '评价成功'
                            ,skin: 'msg'
                            ,time: 2
                        });
                        setTimeout("window.location.href = '/shopping/allOrder';",2000)
                    }else{
                        layer.open({
                            content: res.message
                            ,skin: 'msg'
                            ,time: 2
                        });
                    }

                });
            },
        }
    })
</script>
<!--
</body>
</html>
-->
