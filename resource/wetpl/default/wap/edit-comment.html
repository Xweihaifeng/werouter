<#extend#>public/domain/domain_extend.html</#extend#>
<link href="{{PATH_TML}}css/edit-comment.css" rel="stylesheet">

<script type="text/javascript">
    show.header = 'no';
    show.footer = 'no';
</script>

<header>
    <span> 发表评价 </span>
    <a class="back" href="javascript:void(0)" onclick="javascript:history.back(-1)"></a>
</header>
<div class="comment-container">
    <div class="commit-btn" @click="submitComment()">提交</div>
    <div v-for="(item, index) in goods">

        <!-- 商品信息 -->
        <div class="good">
            <img :src="ApiMaterPlatQiniuDomain+item.goods_cover" alt="">
            <span>商品评分</span>
            <span v-for="star in item.starList" class="star" :class="{'not-red' : !star.check}" @click="goStar(item,star)"></span>
        </div>

        <!-- 评价内容 -->
        <textarea placeholder="在这里分享使用商品的体验吧~" v-model="item.comment"></textarea>

        <!-- 商品评价多图上传 -->
        <form id="imglabel">
            <li v-for="(value, key) in uploadList" class="imgmore" :id="key">
                <img :src="ApiMaterPlatQiniuDomain+value" alt="" >
            </li>
            <div :id="'look'+index" class="imgmore more">
                <input :id="'pickfiles'+index" :name="'front'+index" multiple="" accept="" type="file" class="img-val" @change="InitQiNiv(index,item,item.weid)"/>
            </div>
        </form> 
    </div>
</div>
<script>
    new Vue({
        el : "#app",
        data : {
            orderObj : {},
            uploadList: [],
            goods: []
        },
        mounted() {
            this.$nextTick(()=>{
                var originData = JSON.parse(window.localStorage.getItem('orderObj'));
                for(var i=0; i< originData.goods.length;i++){
                    var arr = [];
                    for(var a=0;a<5;a++){
                        var obj = {};
                        obj.id = a;
                        obj.check = true;
                        arr.push(obj)
                    }
                    originData.goods[i].starList = arr;
                    originData.goods[i].comment = '';
                }
                this.orderObj = originData;
                for (var i = 0; i < this.orderObj.goods.length; i++) {
                    this.orderObj.goods[i]['imgs'] = [];
                }         
                this.goods = this.orderObj.goods;
                // this.orderObj.goods.map(x => this.uploadList.push({id: x.weid, imgs: []}))
                // console.log(this.orderObj.goods)
            })

        },
        methods :{
            goStar : function (item,star) {
                star.check = !star.check;
                if(star.check){
                    //该位置的index值是几，红色星星选到几
                    for(var i=0; i<=star.id;i++){
                        item.starList[i].check = true;
                    }
                }else{
                    //如果取消打星，则将从index+1开始到最后的星星置灰
                    star.check = true;
                    for(var i=star.id+1;i<=4;i++){
                        item.starList[i].check = false;
                    }
                }
            },
            submitComment : function () {
                for(var a=0; a<this.orderObj.goods.length; a++){
                    var sendObj = {
                        order_id : this.orderObj.weid,
                        data : []
                    };
                    var obj = {};
                    obj.goods_id = this.orderObj.goods[a].goods_id;
                    obj.order_id = this.orderObj.weid;
                    obj.title = '';
                    obj.content = this.orderObj.goods[a].comment;
                    if(obj.content==''){
                        layer.open({
                            content: '评论内容不能为空！'
                            ,skin: 'msg'
                            ,time: 2
                        });
                        return false;
                    }
                    var arr = this.orderObj.goods[a].starList.filter(function (s) {
                        return s.check === true;
                    });
                    obj.grade = arr.length;
                    sendObj.data.push(obj);
                    this.sendRequest(sendObj)
                }
            },
            sendRequest : function (data) {
                ajax.post('goods/comment/store', data).then((res)=>{
                    if(res.code==200){
                        layer.open({
                            content: '评价成功'
                            ,skin: 'msg'
                            ,time: 2
                        });
                        setTimeout("window.location.href = '/shopping/allOrder';",2000)
                    }else{
                        layer.open({
                            content: res.message
                            ,skin: 'msg'
                            ,time: 2
                        });
                    }

                });
            },
            InitQiNiv(index,item,weid) {
                // if(this.uploadList.length >= 9) {
                if(item.imgs.length >= 9) {
                    layer.open({
                        content: '上传图片不得超过9张！',
                        skin: 'msg',
                        time: 2,
                    });
                    return false;
                }

                var input = $("#pickfiles"+index);
                var formData = new FormData();
                formData.append("file", input[0].files[0]);

                ajax.post('file/uploadfile', formData).then((res)=>{
                    if(res.code == 200) {
                        var result = res.data;
                        console.log(result);
                        this.uploadList.push(result.key);
                       /* this.$nextTick(()=>{
                            item.imgs.push(result.key);
                            console.log(this.goods);
                            this.goods = this.orderObj.goods;
                        })*/
                    }
                })
            }
        }
    })
</script>