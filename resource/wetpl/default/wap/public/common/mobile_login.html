<link rel="stylesheet" href="{{PATH_TML}}js/layui/css/layui.css"/>
<script src="{{PATH_TML}}js/layui/layui.all.js"></script>
<script type="text/javascript">
// 需要依赖layer moble
function mb_login(href){
    var weid = $app.get_storage('weid');
/*    layer.open({
        content: '仅需一步,即可激活您的账号'
        ,btn: ['激活', '暂不']
        ,style: 'width: 260px; color: #818180;'
        ,yes: function(index){
            layer.open({
                content: `
                <div id="login_vue">
                    <div id="app_ss">
                        <div id="login-info">
                            <ul>
                                <li id="phonenum">
                                    <input type="text" v-model="login.phone" value="" name="login_phone" placeholder="请输入手机号码" maxlength="11" id="login_phone">
                                </li>
                                <li id="checknum">
                                    <input type="text" v-model="login.code" value="" name="login_check"  placeholder="请输入手机验证码" maxlength="6" id="login_check"> <span v-if="check_num>0">剩余{{check_num}}秒</span> <span v-else @click="code();">{{code_string}}</span>
                                </li>
                            </ul>
                        </div>
                        <div ><a class="layui-layer-btn0" @click="login_post();">激活</a></div>
                    </div>
                </div>
                `
            });

            new Vue({
                el: '#login_vue',
                data: {
                   code_string : '获取验证码',
                   login: {
                        phone : '',
                        code : '',
                        weid : '',
                        ref_type : pages_type,
                        from_type : '',
                        ref_url : window.location.pathname,
                        type : '',
                        domain : pages_index
                   },
                   check_num : 0,
                   verification : {
                        'phone' : /^((1[1-9]{1})+\d{9})$/,
                        'check' : /^\d{6}$/,
                   }
                },
                mounted() {
                },
                methods:{
                    timer(){
                        setTimeout(()=>{
                            if(!this.check_num == 0)
                            {
                                this.check_num--;
                                this.timer();
                            }
                        } , 1000);
                    },
                    code (){

                        if(!this.verification.phone.test(this.login.phone))
                        {
                            mb_message('手机号不对');
                        }
                        this.check_num = 60;
                        ajax.post('codes' , {'phone' : this.login.phone}).then((data)=>{
                            if(data.code == 200)
                            {
                                //this.check_num = 60;
                                this.timer();
                            }
                        });
                    },
                    login_post(){
                        if(!this.verification.phone.test(this.login.phone))
                        {
                            mb_message('手机号不对');
                            return;
                        }

                        if(!this.verification.check.test(this.login.code))
                        {
                            mb_message('验证码有误!');
                            return;
                        }
                        if(is_wx == 'yes')
                        {
                            var weid = $app.get_cookie('weid');
                            this.login.weid = weid;
                            this.login.type = 1;
                            this.login.from_type = 2;
                            ajax.post('userAct' , this.login).then((data)=>{
                                if(data.code == 200)
                                {
                                    $app.set_login_data(data);
                                    $app.open_page(href);
                                }
                            });
                        }
                        else
                        {
                            ajax.post('login' , this.login).then((data)=>{
                                if(data.code == 200)
                                {
                                    $app.set_login_data(data);
                                    $app.open_page(href);
                                }
                            });
                        }
                    }
                }
            });
        }
    });*/
    layui.use('layer', function() {
        var $ = layui.jquery, layer = layui.layer;
        var active = {
            notice: function () {
                layer.confirm('仅需一步，即可激活您的账号', {
                    skin: 'confirm-class',
                    title: false,
                    closeBtn: false,
                    btn: ['暂不', '激活'],
                    shade: 0.5,
                    shadeClose: true,
                    area: ['2.25rem', 'auto']
                }, function (index) {
                    layer.close(index)
                }, function (index) {
                    layer.close(index)
                    layer.open({
                        skin: 'active-class'
                        , type: 1
                        , title: false //不显示标题栏
                        , closeBtn: false
                        , shadeClose: true
                        , area: ['320px', '250px']
                        , shade: 0.5
                        , id: 'LAY_layuipro' //设定一个id，防止重复弹出
                        , btn: ['激活']
                        , btnAlign: 'c'
                        , moveType: 1 //拖拽模式，0或者1
                        , content: `
                            <div id="app">
                            <!--<p style="font-size: 16px; margin-top: 25px; text-align: center;">请激活您的账号</p>-->
                            <div id="login-info">
                                <ul>
                                    <li id="phonenum">
                                        <!--<span>+86 <img src="/common/img/downarrow.png" alt=""/></span>-->
                                        <input type="text" placeholder="请输入手机号码" maxlength="11" id="phone" v-model="phone" />
                                    </li>
                                    <li id="checknum">
                                        <input type="text" placeholder="请输入手机验证码" maxlength="6" id="check" v-model="check" />
                                        <span @click="getCheck">{{ info }}</span>
                                    </li>
                                </ul>
                            </div>
                            </div>
                            `
                        , success: function (layero) {
                            $("#layui-layer1").css('overflow', 'hidden');
                            /*new Vue({
                                el: '#app',
                                data: {
                                    phone: '',
                                    check: '',
                                    info: '获取验证码',
                                    lock: false,
                                    backurl: '',
                                    isCheck: false,
                                    weid: '',
                                    token: ''
                                },
                                created: function () {
                                    let self = this;
                                    self.backurl = sessionStorage.getItem('currentPage');
                                    self.weid = localStorage.getItem('weid');
                                    self.token = localStorage.getItem('token');
                                    $('.layui-layer-btn0').click(function () {
                                        let phonenum = $('#phone').val();
                                        let checknum = $('#check').val();
                                        if (/^1[3|4|5|7|8][0-9]{9}$/.test(phonenum)) {
                                            if (/^[0-9]{6}$/.test(checknum)) { //发送手机和验证码验证成功
                                                function is_weixn() {
                                                    var ua = navigator.userAgent.toLowerCase();
                                                    if (ua.match(/MicroMessenger/i) == "micromessenger") {
                                                        return true;
                                                    } else {
                                                        return false;
                                                    }
                                                }

                                                //if (is_weixn()) {
                                                //    tologin(apiUrl + 'userAct', phonenum, checknum, self.weid);
                                                //} else {
                                                tologin(LOGIN, phonenum, checknum, self.weid);
                                                //}
                                            } else {
                                                layer.msg("手机验证码输入错误", {
                                                    time: 1500
                                                })
                                            }
                                        } else {
                                            layer.msg("请输入正确的手机号码", {
                                                time: 1500
                                            })
                                        }
                                    })
                                },
                                methods: {
                                    getCheck: function () {
                                        let self = this;
                                        let count = 59;
                                        let phonenum = self.phone;
                                        if (/^1[3|4|5|7|8][0-9]{9}$/.test(phonenum)) {
                                            getChecknum(phonenum);
                                            if (!self.lock) {
                                                let evt = setInterval(function () {
                                                    self.lock = true;
                                                    if (count > 0) {
                                                        self.info = count-- + '秒';
                                                    } else {
                                                        self.info = '重新发送验证码';
                                                        self.lock = false;
                                                        clearInterval(evt);
                                                    }
                                                }, 1000)
                                            }
                                        } else {
                                            layer.msg("请输入正确的手机号码", {
                                                time: 1500
                                            })
                                        }
                                    },
                                    login: function () {
                                        let self = this;
                                        let phonenum = self.phone;
                                        let checknum = self.check;
                                    }
                                }
                            })*/


                            new Vue({
                                el: '#app',
                                data: {
                                    code_string : '获取验证码',
                                    login: {
                                        phone : '',
                                        code : '',
                                        weid : '',
                                        ref_type : pages_type,
                                        from_type : '',
                                        ref_url : window.location.pathname,
                                        type : '',
                                        domain : pages_index
                                    },
                                    check_num : 0,
                                    verification : {
                                        'phone' : /^((1[1-9]{1})+\d{9})$/,
                                        'check' : /^\d{6}$/,
                                    }
                                },
                                mounted() {
                            },
                            methods:{
                                timer(){
                                    setTimeout(()=>{
                                        if(!this.check_num == 0)
                                        {
                                            this.check_num--;
                                            this.timer();
                                        }
                                    } , 1000);
                                },
                                code (){

                                    if(!this.verification.phone.test(this.login.phone))
                                    {
                                        mb_message('手机号不对');
                                    }
                                    this.check_num = 60;
                                    ajax.post('codes' , {'phone' : this.login.phone}).then((data)=>{
                                        if(data.code == 200)
                                        {
                                            //this.check_num = 60;
                                            this.timer();
                                        }
                                    });
                                },
                                login_post(){
                                    if(!this.verification.phone.test(this.login.phone))
                                    {
                                        mb_message('手机号不对');
                                        return;
                                    }

                                    if(!this.verification.check.test(this.login.code))
                                    {
                                        mb_message('验证码有误!');
                                        return;
                                    }
                                    if(is_wx == 'yes')
                                    {
                                        var weid = $app.get_cookie('weid');
                                        this.login.weid = weid;
                                        this.login.type = 1;
                                        this.login.from_type = 2;
                                        ajax.post('userAct' , this.login).then((data)=>{
                                        if(data.code == 200)
                                        {
                                            $app.set_login_data(data);
                                            $app.open_page(href);
                                        }
                                    });
                                    }
                                    else
                                    {
                                        ajax.post('login' , this.login).then((data)=>{
                                        if(data.code == 200)
                                        {
                                            $app.set_login_data(data);
                                            $app.open_page(href);
                                        }
                                    });
                                    }
                                }
                            }
                        });
                        }
                    });

                });

            }
        };
        active.notice();
    })
}

</script>

