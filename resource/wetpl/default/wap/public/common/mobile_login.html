<script src="/common/public/js/layer_mobile/layer.js"></script>
<script type="text/javascript">
// 需要依赖layer moble
function mb_login(href){
    var weid = $app.get_storage('weid');
    layer.open({
        content: '仅需一步,即可激活您的账号'
        ,btn: ['激活', '暂不']
        ,style: 'width: 60% ;'
        ,yes: function(index){
            layer.open({
                content: `
                <div id="login_vue">
                    <div id="app_ss"  >
                        <div id="login-info">
                            <ul>
                                <li id="phonenum">
                                    <input type="text" v-model="login.phone" value="" name="login_phone" placeholder="请输入手机号码" maxlength="11" id="login_phone">
                                </li> 
                                <li id="checknum">
                                    <input type="text" v-model="login.code" value="" name="login_check"  placeholder="请输入手机验证码" maxlength="6" id="login_check"> <span v-if="check_num>0">剩余{{check_num}}秒</span> <span v-else @click="code();">{{code_string}}</span>
                                </li>
                            </ul>
                        </div>
                         <div ><a class="layui-layer-btn0" @click="login_post();">激活</a></div>
                    </div>
                </div>
                `
                ,style:' height : 35%;padding:0px;0px;box-shadow: 1px 1px 50px rgba(0,0,0,.3);'

            });
            
            new Vue({
                el: '#login_vue',
                data: {
                   code_string : '获取验证码',
                   login: {
                        phone : '',
                        code : '',
                        weid : '',  
                        ref_type : pages_type,
                        from_type : '',
                        ref_url : window.location.pathname,
                        type : '',
                        domain : pages_index
                   },
                   check_num : 0,
                   verification : {
                        'phone' : /^((1[1-9]{1})+\d{9})$/,
                        'check' : /^\d{6}$/,
                   }
                },
                mounted() {
                },
                methods:{
                    timer(){
                        setTimeout(()=>{
                            if(!this.check_num == 0)
                            {
                                this.check_num--;
                                this.timer();
                            }
                        } , 1000);
                    },
                    code (){
                        if(!this.verification.phone.test(this.login.phone)) 
                        { 
                            mb_message('手机号不对');
                        }
                        this.check_num = 60;
                        ajax.post('codes' , {'phone' : this.login.phone}).then((data)=>{
                            if(data.code == 200)
                            {
                                //this.check_num = 60;
                                this.timer();
                            }
                        });
                    },
                    login_post(){
                        if(!this.verification.phone.test(this.login.phone)) 
                        { 
                            mb_message('手机号不对');
                            return;
                        }

                        if(!this.verification.check.test(this.login.code)) 
                        { 
                            mb_message('验证码有误!');
                            return;
                        }
                        if(is_wx == 'yes')
                        {
                            var weid = $app.get_cookie('weid');
                            this.login.weid = weid;
                            this.login.type = 1;
                            this.login.from_type = 2;
                            ajax.post('userAct' , this.login).then((data)=>{
                                if(data.code == 200)
                                {
                                    $app.set_login_data(data);
                                    $app.open_page(href);
                                }
                            });
                        }
                        else
                        {
                            ajax.post('login' , this.login).then((data)=>{
                                if(data.code == 200)
                                {
                                    $app.set_login_data(data);
                                    $app.open_page(href);
                                }
                            });
                        }
                    }
                }
            }); 
        }
    });
}

// 弹出窗口
function mb_message(message)
{
    layer.open({
        content: message
        ,skin: 'msg'
        ,time: 2 //2秒后自动关闭
    });
}
</script>

